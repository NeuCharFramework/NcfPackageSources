@page
@model Senparc.Xncf.PromptRange.Areas.Admin.Pages.PromptRange.PromptModel
@{
    ViewData["Title"] = "PromptRange Prompt";
    Layout = "_Layout_Vue";
}

@section Style {
    <link href="~/css/PromptRange/prompt.css" rel="stylesheet" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
}

@section breadcrumbs {
    <el-breadcrumb-item>扩展模块</el-breadcrumb-item>
    <el-breadcrumb-item>提示词靶场</el-breadcrumb-item>
    <el-breadcrumb-item>Prompt</el-breadcrumb-item>
}


<div class="promptPage">
    @*左侧 输入测试 *@
    <div class="promptPage_leftArea" 
         :class="{'promptPage_leftAreaHide':promptLeftShow}"
         :style="!promptLeftShow && !centerAreaMaximized && !rightAreaMaximized ? {width: leftAreaWidth + 'px'} : {}">
        @*配置*@
        <div class="boxCard configurineArea" v-if="isBoxVisible">
            @*选择靶场*@
            <div class="configurineAreaItem rangeBox">
                <div class="d-flex align-flex-end" style="gap: 10px">
                    <div class="w-100">
                        <div class="d-flex align-center justify-content-between" style="gap: 5px;margin-bottom: 5px">
                            <div class="d-flex align-center">
                                <img src="~/image/PromptRange/prompt_selectPrompt.svg" alt="" class="imgIcon" />
                                <div class="titleContent">选择靶场</div>
                            </div>
                            <div>
                                <el-button type="primary" size="mini" @@click="expectedPluginOpen">导出 plugins</el-button>
                                <el-button type="primary" size="mini" @@click="uploadPluginVisible = true">导入 plugins</el-button>
                                <el-button type="primary" size="mini" icon="el-icon-plus" @@click="addPromptField">新增靶场</el-button>
                            </div>

                        </div>
                        <el-select v-model="promptField" filterable placeholder="请选择靶场" :popper-append-to-body="true" class="selectRow" @@change="promptChangeHandel($event,'promptField')">
                            <el-option v-for="item in promptFieldOpt"
                                       v-key="item.id"
                                       :label="item.label"
                                       :value="item.value"
                                       :disabled="item.disabled">
                                <div class="d-flex justify-content-between align-center">
                                    <span>{{ item.label }}</span>
                                    <div>

                                        <el-button type="primary" size="mini" @@click="renameField($event,item)">重命名靶场</el-button>
                                        <el-button type="danger" size="mini" @@click="fieldDeleteHandel($event,item.id)">删除</el-button>
                                    </div>
                                </div>
                            </el-option>
                        </el-select>
                    </div>

                    <div class="w-100">
                        <div class="d-flex align-center justify-content-between" style="gap: 5px;margin-bottom: 5px">
                            <div class="d-flex align-center" style="gap: 5px;">
                                <img src="~/image/PromptRange/prompt_selectPrompt.svg" alt="" class="imgIcon" />
                                <div class="titleContent">选择靶道</div>
                            </div>
                            <div class="d-flex align-center" style="gap: 5px;">
                                <el-button type="primary" size="mini" icon="el-icon-s-data" @@click="openMapDialog" 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: bold;">
                                    导图
                                </el-button>
                                <i class="el-icon-document-copy" style="font-size: 1.3rem;cursor: pointer" @@click="copyInfo"></i>
                            </div>
                        </div>
                        <el-select v-model="promptid" :disabled="!promptField" :popper-append-to-body="true" :placeholder="promptField?'请选择靶道':'请先选择靶场'" class="selectRow" @@change="promptChangeHandel($event,'promptid')">
                            <el-option v-for="item in promptOpt"
                                       v-key="item.id"
                                       :label="item.label"
                                       :value="item.value"
                                       :disabled="item.disabled">
                                <div class="d-flex justify-content-between align-center" style="gap:20px">
                                    <span>{{ item.label }}</span>
                                    <div style="display: flex; gap: 5px;">
                                        <el-button type="success" size="mini" icon="el-icon-s-data" @@click="openCompareDialog($event, item)">对比</el-button>
                                        <el-button type="primary" size="mini" @@click="promptNameField($event,item)">{{item.nickName ? '修改靶道名称' : '设置靶道名称'}}</el-button>
                                        <el-button type="primary" size="mini" @@click="promptNameRest($event,item.id)">重置名称</el-button>
                                        <el-button type="danger" size="mini" @@click="promptDeleteHandel($event,item.id)">删除</el-button>
                                    </div>
                                </div>
                            </el-option>
                        </el-select>
                    </div>
                </div>
            </div>
            @*选择模型*@
            <div class="configurineAreaItem modelBox" style="width: 100%;">
                <div class="titleRow" style="padding: 5px">
                    <div class="titleRow_leftBox">
                        <img src="~/image/PromptRange/prompt_selectModel.svg" alt="" class="imgIcon" />
                        <div class="titleContent">选择模型</div>
                    </div>
                    <div class="d-flex" style="gap:5px">
                        <el-button size="mini" @@click="refreshModelOpt" :loading="waitRefreshModel">刷新</el-button>
                        <el-button type="primary" size="mini" @@click="toAIKernel">管理模型</el-button>
                    </div>
                </div>
                <div>
                    <el-select v-model="modelid" placeholder="请选择模型" :disabled="dodgersLoading" class="selectRow model-select" @@change="promptChangeHandel($event,'modelid',modelid)">
                        <el-option v-for="item in modelOpt"
                                   v-key="item.id"
                                   :label="item.displayName || item.alias"
                                   :value="item.value"
                                   :disabled="item.disabled">
                            <div class="model-option-content">
                                <div class="model-name-row">
                                    <span class="model-name">{{ item.alias || '未命名模型' }}</span>
                                    <span class="model-version" v-if="item.apiVersion">v{{ item.apiVersion }}</span>
                                </div>
                                <div class="model-deployment" v-if="item.deploymentName">（{{ item.deploymentName }}）</div>
                            </div>
                        </el-option>
                    </el-select>
                </div>
            </div>
            @*输入*@
            <div class="boxCard inputPromptArea" style="padding: 0">
                @* 请新建或选择靶场 mask *@
                <div class="prompt-mask" v-if="promptFieldOpt.length===0||!promptField" style="z-index: 1350;">
                    <div class="text-center">
                        <i class="el-icon-lock" style="font-size:2.5rem"></i>
                        <br>请新建或选择靶场后再进行操作
                    </div>
                </div>
                @* 连发 mask *@
                <div class="prompt-mask" v-if="dodgersLoading">
                    <div class="text-center">
                        <i class="el-icon-lock" style="font-size:2.5rem"></i>
                        <br>当前处于连发模式，内容已锁定
                        <br>如需修改，请切换其他模式
                    </div>
                </div>
                @*模型参数设置*@
                <div class="configurineAreaItem paramBox" style="padding: 15px">
                    <div class="titleRow">
                        <div class="titleRow_leftBox">
                            <i class="requirIcon">*</i>
                            <div class="titleContent">模型参数</div>
                        </div>
                       <div class="titleRow_rightBox">
                            @* parameterViewShow=!parameterViewShow *@
                            <el-button size="mini" @@click="resetConfigurineParam(true)">重置</el-button>
                            @* <i class="el-icon-caret-top icon" :class="{'rotate':parameterViewShow}" @@click="parameterViewToggle"></i>*@
                        </div>
                    </div>
                    <div class="paramBox_contentBox" :class="{'paramBox_contentBoxCollapse':parameterViewShow}">
                        <div v-for="item in parameterViewList" v-key="item.formField" class="paramBox_contentBox_item">
                            <div class="lableRow">
                                <div class="lableBtn">
                                    <span>{{ item.label }}</span>
                                    <el-tooltip class="item" effect="dark" :content="item.tips" placement="top">
                                        <i class="el-icon-warning-outline"></i>
                                    </el-tooltip>
                                </div>
                            </div>
                            @* v-bind: *@
                            <el-input v-model="item.value" placeholder="" class="inputBox" v-bind:style="{'flex':item.isSlider?'':'1'}" @@input="parameterInputHandle($event,item)" @@change="promptChangeHandel($event,item.formField)"></el-input>
                            <div v-if="item.isSlider" class="sliderBox">
                                <span>{{item.sliderMin}}</span>
                                <el-slider v-model="item.value" :min="item.sliderMin" :max="item.sliderMax" :step="item.sliderStep" class="slider" @@change="promptChangeHandel($event,item.formField)"></el-slider>
                                <span>{{item.sliderMax}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                @* 设置ai评分标准 :disabled="!promptid" aiScoreFormOpenDialog aiScoreFormVisible = true*@
                <div style="padding-left: 15px; margin-top:25px;">
                    <el-button type="primary" :disabled=!isAIGrade size="mini" @@click="aiScoreFormOpenDialog">设置 AI 评分标准</el-button>
                    <el-switch active-color="#13ce66" inactive-color="#ff4949" v-model="isAIGrade" active-text="开" inactive-text="关"></el-switch>
                </div>
            </div>
        </div>
        <div class="trapezoid" @@click="foldsidebar">
            <i class="el-icon-caret-right icon" style="position: absolute;top: 15px;" :class="{'sidebarview':foldsidebarShow}"></i>
        </div>

       
    </div>
    
    @* 左侧和中间区域之间的拖动分隔条 *@
    <div class="resize-handle resize-handle-left" 
         v-if="!promptLeftShow && !centerAreaMaximized && !rightAreaMaximized"
         @@mousedown="startResizeLeft"
         @@dblclick="resetAreaWidths"
         title="拖动调整宽度 | 双击还原默认"></div>
    
    @*中间 输入Prompt*@
    <div class="promptPage_centerArea" 
         v-if="!box2Hidden" 
         :class="{'promptPage_centerAreaMaximized': centerAreaMaximized}"
         :style="!centerAreaMaximized && !rightAreaMaximized ? {width: centerAreaWidth + 'px'} : {}">
        <div class="boxCard entertarget" >
                @* 请新建或选择靶场 mask *@
                <div class="prompt-mask" v-if="promptFieldOpt.length===0||!promptField" style="z-index: 1350;">
                    <div class="text-center">
                        <i class="el-icon-lock" style="font-size:2.5rem"></i>
                        <br>请新建或选择靶场后再进行操作
                    </div>
                </div>
                @* 连发 mask *@
                <div class="prompt-mask" v-if="dodgersLoading">
                    <div class="text-center">
                        <i class="el-icon-lock" style="font-size:2.5rem"></i>
                        <br>当前处于连发模式，内容已锁定
                        <br>如需修改，请切换其他模式
                    </div>
                </div>
                @*输入Prompt*@
                <div class="promptContetnPmroparaBox" style="padding: 5px">
                    @* 输入Prompt内容 *@
                    <div class="configurineAreaItem leftItemBox">
                        <div class="titleRow">
                            <div class="titleRow_leftBox">
                                <img src="~/image/PromptRange/prompt_inputPrompt.svg" alt="" class="imgIcon" />
                                <div class="titleContent">输入Prompt</div>
                            </div>
                            <div class="titleRow_rightBox">
                                <el-button size="mini" @@click="resetInputPrompt">重置</el-button>
                                <el-button type="primary" size="mini" :icon="promptParamVisible?'el-icon-s-fold':'el-icon-s-unfold'" @@click="promptParamVisible = !promptParamVisible">请求参数</el-button>
                                <i class="el-icon-full-screen" style="font-size: 1.3rem;cursor: pointer;" @@click="Amplification('box2')"></i>
                            </div>
                        </div>
                        <div class="promptContentBox">
                        @* contenteditable编辑器，支持内联高亮 *@
                        <div class="promptInput prompt-rich-editor"
                             contenteditable="true"
                             ref="promptEditor"
                             @@input="handleEditorInput"
                             @@paste="handlePaste"
                             @@keydown="handleKeyDown"
                             @@blur="applyHighlight"
                             @@compositionstart="isComposing = true"
                             @@compositionend="isComposing = false"
                             :data-placeholder="content ? '' : '请输入Prompt内容'">
                        </div>
                            
                            @* 变量提示卡片 *@
                            <div class="prompt-variables-hint" v-if="detectedVariables.length > 0">
                                <div class="hint-title">
                                    <i class="el-icon-info"></i>
                                    检测到 {{ detectedVariables.length }} 个变量
                                </div>
                                <div class="variables-list">
                                    <el-tag v-for="varItem in detectedVariables" 
                                            :key="varItem.name"
                                            :type="varItem.isDefined ? 'success' : 'danger'"
                                            size="small"
                                            class="variable-tag">
                                        {{ varItem.fullMatch }}
                                        <i v-if="varItem.isDefined" class="el-icon-check" title="已定义"></i>
                                        <i v-else class="el-icon-warning" title="未定义"></i>
                                    </el-tag>
                                </div>
                            </div>
                            <div class="remarkRow">
                                <el-input v-model="remarks" type="textarea"
                                          :rows="4"
                                          resize="none"
                                          maxlength="200"
                                          show-word-limit
                                          placeholder="请输入备注" class="remarkInputBox" @@change="promptChangeHandel($event,'remarks')" @@blur="promptRemarkSave">
                                </el-input>
                                @* style="z-index: 1250;" *@
                                <div class="operationBox">
                                    @* 选择连发次数  *@
                                    <el-dropdown trigger="click" @@command="changeNumsBtn" type="primary" size="small">
                                        <div class="numsOfResultsBox">
                                            连发次数：<span class="numVal">{{numsOfResults}}</span>
                                            <i class="el-icon-arrow-down"></i>
                                        </div>
                                        <el-dropdown-menu slot="dropdown">
                                            <el-dropdown-item v-for="btn of numsOfResultsOpt" :key="btn" :command="btn">{{btn}}</el-dropdown-item>
                                        </el-dropdown-menu>
                                    </el-dropdown>
                                    @* 打靶按钮  v-loading="targetShootLoading" *@
                                    <div class="targetShootBtnRow">
                                        <el-dropdown trigger="click" @@command="changeBtn" split-button type="primary" @@click="clickSendBtn" size="small">
                                            {{sendBtnText}}
                                            <el-dropdown-menu slot="dropdown">
                                                <el-dropdown-item v-for="btn of sendBtns" :key="btn.text" :disabled="btn.text==='连发'&&(!promptid||outputList.length===0||pageChange)" :command="btn.text">{{btn.text}}</el-dropdown-item>
                                            </el-dropdown-menu>
                                        </el-dropdown>
                                        <el-tooltip class="item" effect="dark" placement="top">
                                            <div slot="content" class="">打靶: 根据当前填写的内容或者选择的靶场和靶道，创建新的靶道。<br />连发：根据当前选择的靶道信息，连续输出多个结果。<br />草稿：保存当前输入的内容，并创建新的靶道。</div>
                                            <i class="el-icon-warning-outline" :style="sendBtnText==='连发'?'filter:invert(1)':''"></i>
                                        </el-tooltip>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @* Prompt请求参数 - 移到leftItemBox内部，作为下方区域 *@
                        <div class="promptParamSection" :class="{'paramSectionHide': !promptParamVisible}">
                        <div class="titleRow" style="height:28px;">
                            <div class="titleRow_leftBox">
                                <div class="titleContent">Prompt请求参数</div>
                            </div>
                        </div>
                        <div class="promptPmroparaBox">
                            <el-form ref="promptParamForm" :model="promptParamForm" :rules="rules" label-width="70px" label-position="left">
                                <div class="formItem">
                                    <el-form-item label="前缀" prop="prefix">
                                        <el-input size="mini" v-model="promptParamForm.prefix" autocomplete="off" placeholder="如：{{$"></el-input>
                                    </el-form-item>
                                    <el-form-item label="后缀" prop="suffix">
                                        <el-input size="mini" v-model="promptParamForm.suffix" autocomplete="off" placeholder="如：}}"></el-input>
                                    </el-form-item>
                                </div>
                                @* 变量名 变量值 *@
                                <el-table :data="promptParamForm.variableList" border
                                          max-height="150"
                                          style="width: 100%">
                                    <el-table-column label="变量名">
                                        <template slot-scope="scope">
                                            @*<el-input size="mini" v-model="scope.row.name" autocomplete="off" placeholder="请输入变量名"></el-input>*@
                                            <el-input size="mini" type="textarea"
                                                      autosize
                                                      autocomplete="off"
                                                      placeholder="请输入变量名"
                                                      v-model="scope.row.name">
                                            </el-input>
                                            @* <el-form-item :prop="'variableList.' + scope.$index + '.name'" :rules="rules.variableName" label-width="0px">
                                            <el-input size="mini" v-model="scope.row.name" autocomplete="off" placeholder="请输入变量名"></el-input>
                                            </el-form-item> *@
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="变量值">
                                        <template slot-scope="scope">
                                            @*<el-input size="mini" v-model="scope.row.value" autocomplete="off" placeholder="请输入变量值"></el-input>*@
                                            <el-input size="mini" type="textarea"
                                                      autosize
                                                      autocomplete="off"
                                                      placeholder="请输入变量值"
                                                      v-model="scope.row.value">
                                            </el-input>
                                            @* <el-form-item :prop="'variableList.' + scope.$index + '.value'" :rules="rules.variableValue" label-width="0px">
                                            <el-input size="mini" v-model="scope.row.value" autocomplete="off" placeholder="请输入变量值"></el-input>
                                            </el-form-item> *@
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="50">
                                        <template slot-scope="scope">
                                            <i class="el-icon-delete deleteIcon" @@click="deleteVariableBtn(scope.$index)"></i>
                                        </template>

                                    </el-table-column>
                                </el-table>
                                @* <div v-for="(item,index) in promptParamForm.variableList" v-key="index" class="formItem">
                                <el-form-item label="" :prop="'variableList.' + index + '.name'" :rules="rules.variableName" label-width="0px">
                                <el-input v-model="item.name" autocomplete="off" placeholder="请输入变量名"></el-input>
                                </el-form-item>
                                <el-form-item label="" :prop="'variableList.' + index + '.value'" :rules="rules.variableValue" label-width="0px">
                                <el-input v-model="item.value" autocomplete="off" placeholder="请输入变量值"></el-input>
                                </el-form-item>
                                <i class="el-icon-delete deleteIcon" @@click="deleteVariableBtn(index)"></i>
                                </div> *@
                                <div class="addVariableRow">
                                    <el-button type="primary" size="mini" icon="el-icon-plus" @@click="addVariableBtn">新增变量</el-button>
                                </div>
                            </el-form>
                            <div class="footerBtnRow">
                                @* <el-button size="mini" @@click="promptParamFormClose">取 消</el-button> *@
                                @* <el-button type="primary" size="mini" v-loading="promptParamFormLoading" @@click="promptParamFormSubmit">确 定</el-button> *@
                            </div>
                        </div>
                        </div>
                    </div>
                </div>


            </div>
    </div>
    
    @* 中间和右侧区域之间的拖动分隔条 *@
    <div class="resize-handle resize-handle-right" 
         v-if="!box2Hidden && !centerAreaMaximized && !rightAreaMaximized"
         @@mousedown="startResizeRight"
         @@dblclick="resetAreaWidths"
         title="拖动调整宽度 | 双击还原默认"></div>
    
    @*右侧 评分|分析*@
    <div class="promptPage_rightArea" 
         :class="{'promptPage_rightAreaMaximized': rightAreaMaximized, 'promptPage_rightAreaHidden': box1Hidden && box3Hidden}">
        @*输出*@
        <div class="boxCard outputArea" 
             :style="{'z-index':isPageLoading && dodgersLoading ? 1000000 : 999}" 
             v-if="!box1Hidden"
             @@mousemove="handleOutputAreaMouseMove"
             @@mouseleave="handleOutputAreaMouseLeave">
            <div class="promptVersion">
                <div class="promptVersion-content">
                    <div class="promptVersion-row">
                        <span>Prompt 版本: <strong>{{promptDetail.fullVersion}}</strong></span>
                        <i class="el-icon-document-copy" style="font-size: 1.0rem;cursor: pointer;margin-left: 8px;" @@click="copyInfo"></i>
                    </div>
                    <div class="promptVersion-row promptVersion-info">
                        <span style="margin-right:5px;">靶场:</span>
                        <span style="margin-right:15px;">{{promptDetail.promptFieldStr||'--'}}</span>
                        <span style="margin-right:5px;">靶道:</span>
                        <span style="margin-right:15px;">{{promptDetail.promptStr||'--'}}</span>
                        <span style="margin-right:5px;">瞄准:</span>
                        <span>{{promptDetail.tacticsStr||'--'}}</span>
                    </div>
                </div>
                <span><i class="el-icon-full-screen" style="font-size: 1.3rem;cursor: pointer;" @@click="Amplification('box1')"></i></span>
            </div>
          
            <div class="titleRow">
                <div class="titleRow_leftBox">
                    <img src="~/image/PromptRange/prompt_output.svg" alt="" class="imgIcon" />
                    <div class="titleContent">输出</div>
                </div>
                <div class="titleRow_scoreBox">
                    <span>平均分:</span>
                    <span>{{outputAverageDeci>-1?outputAverageDeci.toFixed(1):'--'}}</span>
                </div>
                <div class="titleRow_scoreBox">
                    <span>最高分:</span>
                    <span>{{outputMaxDeci>-1?outputMaxDeci.toFixed(1):'--'}}</span>
                </div>
            </div>
            <div class="outputArea_contentBox" id="resultBox" @@scroll="handleResultScroll">
                <div v-for="(item,index) in outputList" v-key="item.id" class="contentBoxItem" v-bind:class="{'contentBoxActiveItem':outputActive === index}" @@click="app.outputSelectSwitch(index)" :data-result-index="index">
                    <div class="promptResult_Item_Title">
                        <div class="promptReultTimeArea">
                            <span>{{item.addTime}} [耗时(毫秒):{{item.costTime}}]</span>
                        </div>
                        <div class="copyButtonArea">
                            <a href="javascript:void(0);" @@click="copyPromptResult(item,false)" title="复制带格式的 HTML 代码"><i class="fa fa-copy"></i> HTML</a>
                            <a href="javascript:void(0);" @@click="copyPromptResult(item,true)" title="复制原始内容（例如将复制 markdown 标记）"><i class="fa fa-copy"></i> 原始</a>
                        </div>
                    </div>
                    <div class="contentRow" v-html="item.resultStringHtml">
                    </div>
                    <div class="operateRow" v-if="item.resultString.length>0">
                        <div class="operateRow_item" @@click="app.showRatingView(index,'1')">
                            <img src="~/image/PromptRange/prompt_score.svg" class="imgIcon" />
                            <span :class="checkUseRed(index,item,'robotScore')">
                                AI评分: 
                                <template v-if="robotScoreLoadingMap[item.id]">
                                    <i class="el-icon-loading"></i> AI 评分中...
                                </template>
                                <template v-else>
                                    {{item.robotScore>-1 ? item.robotScore.toFixed(1) : '--'}}
                                </template>
                            </span>
                        </div>
                        <div class="operateRow_item" @@click="app.showRatingView(index,'2')">
                            <img src="~/image/PromptRange/prompt_score.svg" class="imgIcon" />
                            <span :class="checkUseRed(index,item,'humanScore')">手动评分: {{item.humanScore>-1 ? item.humanScore.toFixed(1) : '--'}}</span>
                        </div>
                        <div class="operateRow_item" v-if="item.mode === 2 || item.mode === 'Chat'" @@click="app.continueChat(item.id, index)" style="cursor: pointer; color: #409EFF;">
                            <i class="el-icon-chat-line-round"></i>
                            <span>继续聊天</span>
                        </div>
                    </div>
                    <div v-if="item.isScoreView" class="scoreRow">
                        <div class="tabsArea">
                            @* @@click="app.alBtnScoring(index)" *@
                            <div v-if="item.scoreType === '1'" class="tabsAreaItem" v-bind:class="{'activeTabsItem':item.scoreType === '1'}">AI评分</div>
                            <div v-if="item.scoreType === '2'" class="tabsAreaItem" v-bind:class="{'activeTabsItem':item.scoreType === '2'}">手动评分</div>
                        </div>
                        <div v-if="item.scoreType === '1'" class="alScoreArea">
                            <div v-for="(elItem,elindex) in item.alResultList" v-key="elindex" class="valFormItem">
                                <span class="label">{{elItem.label}}</span>
                                <el-input v-model="elItem.value" clearable placeholder="请输入" class="input" />
                            </div>
                            <div class="aiOperation">
                                <el-button type="primary" size="mini" @@click="saveManualScore(item)">开始打分</el-button>
                                <el-button type="primary" size="mini" icon="el-icon-plus" circle @@click="app.addAlScoring(index)"></el-button>
                            </div>
                        </div>
                        <div v-if="item.scoreType === '2'" class="manualScoreArea">
                            <div class="sliderTextRow">
                                <span>0.0</span>
                                <span>10.0</span>
                            </div>
                            <div class="my-slider">
                                <div class="my-slider__tooltip" :style="style(item.scoreVal)">
                                    <el-tag class="my-slider__tooltip-wrapper"
                                            size="mini"
                                            effect="plain"
                                            type="info">
                                        {{ formatTooltip(item.scoreVal) }}
                                    </el-tag>
                                </div>
                                <el-slider v-model="item.scoreVal"
                                           :show-tooltip="false"
                                           :min="0" :max="10" :step="0.1"></el-slider>
                            </div>
                            @*<el-input v-model="manualScorVal" clearable placeholder="请输入" class="input"></el-input>*@
                            <div class="manualOperation">
                                <el-button type="primary" size="mini" @@click="saveManualScore(item)">保存</el-button>
                                <el-button type="primary" size="mini" @@click="cancelManualScore(index)">取消</el-button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="outputList.length===0" class="emptyDataArea">
                    暂无生成结果
                </div>
            </div>
            @* 自定义滚动条缩略图 *@
            <div class="custom-scrollbar-thumbnail" 
                 v-if="outputList.length > 0" 
                 v-show="showScrollbarThumbnails">
                <div class="thumbnail-track">
                    <div v-for="(item,index) in outputList" 
                         :key="'thumb-'+index"
                         class="thumbnail-item"
                         :class="{'thumbnail-item-active': isResultInView(index)}"
                         :style="getThumbnailStyle(index)"
                         :title="getThumbnailTooltip(item)"
                         @@click="scrollToResult(index)">
                        @* Excel风格数据条背景 *@
                        <div v-if="getFinalScore(item) !== null" 
                             class="thumbnail-score-bar" 
                             :class="getScoreBarClass(item)"
                             :style="getScoreBarStyle(item)">
                        </div>
                        @* 内容容器 *@
                        <div class="thumbnail-content">
                            <span class="thumbnail-time">{{formatTime(item.addTime)}}</span>
                            <span v-if="getFinalScore(item) !== null" class="thumbnail-score">
                                {{getFinalScore(item).toFixed(1)}}分
                            </span>
                        </div>
                    </div>
                    <div class="thumbnail-viewport" :style="getViewportStyle()"></div>
                </div>
            </div>
        </div>
        @*分数趋势图*@
        <div class="boxCard analysisArea" v-if="!box3Hidden">
                
                <div class="titleRow">
                    <div class="titleRow_leftBox">
                        <img src="~/image/PromptRange/prompt_chart.svg" alt="" class="imgIcon" />
                        <div class="titleContent">
                            分数趋势图 <el-tooltip class="item" content="只有一个有分数，图表无法渲染一个数构成的折线" effect="dark" placement="top">
                                <i class="el-icon-warning-outline" style="color:#f00"></i>
                            </el-tooltip>
                        </div>
                        <el-radio v-model="isAvg" :label="true" @@input="getScoringTrendData">平均分</el-radio>
                        <el-radio v-model="isAvg" :label="false" @@input="getScoringTrendData">最高分</el-radio>
                    </div>
                </div>
                <div id="promptPage_scoreChart" key="myCharts" v-if="promptid&&promptid!==''&&chartData.length!==0" class="echartsBox">
                </div>
                <div v-else class="echartsBox">
                    <div class="emptyDataArea">
                        暂无数据
                    </div>
                </div>


            </div>
        
    </div>
    @*版本记录-抽屉 drawer*@
    <div v-if="promptField" class="versionBtn" @@click="seeVersionRecord">版本记录</div>
    <el-drawer :visible.sync="versionDrawer" direction="rtl" title="版本记录" :with-header="false" @@close="versionDrawerClose">
        <div class="versionDrawerArea">
            <div class="versionDrawerArea_titleRow">
                <span>版本记录</span>
                <img src="~/image/PromptRange/prompt_back.svg" class="imgIcon" onclick="app.versionDrawer = false" />
            </div>

            <el-input v-model="versionSearchVal" size="mini" placeholder="请输入名称" class="versionDrawerArea_inputRow">
                <el-button slot="append" icon="el-icon-search" size="mini"></el-button>
            </el-input>

            <div class="versionDrawerArea_contentRow">
                <el-tree ref="versionTree"
                         default-expand-all
                         :props="versionTreeProps"
                         :data="versionTreeData"
                         :filter-node-method="versionTreeFilterNode"
                         node-key="id"
                         :expand-on-click-node="false"
                         class="filter-tree">
                    <div class="custom-tree-node" slot-scope="{ node, data }">
                        <div class="treeLabelBox">{{ node.label }}</div>
                        <el-popover popper-class="versionTreeMorePopover" placement="left" width="118" trigger="hover">
                            <div class="operateArea">
                                <div class="operateItem">
                                    <span style="margin-right:5px;">是否公开</span>
                                    <el-switch v-model="data.isPublic" disabled="true" :width="34" @@change="versionRecordIsPublic(data)">
                                    </el-switch>
                                </div>
                                <div class="operateItem" @@click="versionRecordEdit(data)">编辑</div>
                                <div class="operateItem" @@click="versionRecordGenerateCode(data)">生成代码</div>
                                @* <div class="operateItem" @@click="versionRecordViewNotes(data)">查看备注</div> *@
                                <div class="operateItem" @@click="versionRecordDelete(data)">删除</div>
                            </div>
                            <img slot="reference" src="~/image/PromptRange/prompt_moreDot.svg" class="treeMoreIcon" />
                        </el-popover>
                    </div>
                </el-tree>
            </div>
        </div>
    </el-drawer>
    @*战术选择 dialog*@
    <el-dialog 
        :title="continueChatMode ? '继续聊天' : (promptid ? '战术选择' : '打靶模式')" 
        :visible.sync="tacticalFormVisible" 
        :width="continueChatMode ? '80%' : '50%'"
        :close-on-click-modal="false"
        center 
        @@close="tacticalFormCloseDialog">
        <el-form ref="tacticalForm" :model="tacticalForm" :rules="rules" label-width="70px" label-position="left" class="tacticalFormBox">
            @* 继续聊天模式下不显示战术选择，第一次打靶时（没有promptid）也不显示战术选择 *@
            <el-form-item v-if="!continueChatMode && promptid" label="战术" prop="tactics">
                <el-radio-group v-model="tacticalForm.tactics">
                    <el-radio label="创建顶级战术">
                        <div class="d-f-startr-start-title">创建顶级战术</div>
                        @*<div class="d-f-startr-start-img">

                        </div>*@
                        <div class="d-f-startr-start-nowrap" style="margin-top:7px;">
                            <span>示例：</span>
                            <div>
                                <div>T1</div>
                                <div>T2 (new)</div>
                            </div>
                        </div>
                    </el-radio>
                    <el-radio label="创建平行战术">
                        <div>创建平行战术</div>
                        <div class="d-f-startr-start-nowrap" style="margin-top:7px;">
                            <span>示例：</span>
                            <div class="d-c-startr-start-nowrap">
                                <div>T1.2.3</div>
                                <div>T1.2.4 (new)</div>
                            </div>
                        </div>
                    </el-radio>

                    <el-radio label="创建子战术">
                        <div>创建子战术</div>
                        <div class="d-f-startr-start-nowrap" style="margin-top:7px;">
                            <span>示例：</span>
                            <div class="d-c-startr-start-nowrap">
                                <div>T1.2.3</div>
                                <div>T1.2.3.1 (new)</div>
                            </div>
                        </div>
                    </el-radio>
                    <el-radio label="重新瞄准">
                        <div>重新瞄准</div>
                        <div class="d-f-startr-start-nowrap" style="margin-top:7px;">
                            <span>示例：</span>
                            <div class="d-c-startr-start-nowrap">
                                <div>T1.2.3-A1</div>
                                <div>T1.2.3-A2 (new)</div>
                            </div>
                        </div>
                    </el-radio>
                </el-radio-group>
            </el-form-item>
            <el-form-item v-if="!continueChatMode" label="打靶测试" prop="chatMode">
                <el-radio-group v-model="tacticalForm.chatMode" :disabled="continueChatMode">
                    <el-radio label="对话模式">
                        <div>对话模式</div>
                        <div style="margin-top:5px; font-size:12px; color:#909399;">以对话方式输入，输入后进行打靶</div>
                    </el-radio>
                    <el-radio label="直接测试">
                        <div>直接测试</div>
                        <div style="margin-top:5px; font-size:12px; color:#909399;">直接使用当前的 Prompt 进行测试</div>
                    </el-radio>
                </el-radio-group>
                <div v-if="continueChatMode" style="margin-top: 8px; font-size: 12px; color: #E6A23C;">
                    <i class="el-icon-lock"></i> 继续聊天模式已锁定为对话模式
                </div>
            </el-form-item>
            @* 继续聊天模式下的历史记录显示 *@
            <el-form-item v-if="continueChatMode" label="对话历史">
                <div class="chat-history-container" id="chatHistoryContainer" @@scroll="handleChatHistoryScroll">
                    <div v-if="continueChatHistory.length === 0" class="chat-empty-tip">
                        <i class="el-icon-chat-line-round"></i>
                        <span>暂无对话记录</span>
                    </div>
                    <div v-for="(msg, idx) in continueChatHistory" :key="msg.id || `temp-${idx}`" class="chat-message-item" :class="{'chat-message-user': msg.roleType === 1, 'chat-message-assistant': msg.roleType === 2}">
                        <div class="chat-message-avatar">
                            <i :class="msg.roleType === 1 ? 'el-icon-user' : 'el-icon-service'"></i>
                        </div>
                        <div class="chat-message-content-wrapper">
                            <div class="chat-message-header">
                                <span class="chat-message-role">{{ msg.roleType === 1 ? '用户' : '助手' }}</span>
                                <span class="chat-message-sequence">#{{ msg.sequence }}</span>
                                <span class="chat-message-time">{{ formatChatTime(msg.addTime) }}</span>
                            </div>
                            <div class="chat-message-content" v-html="formatChatContent(msg.content)">
                            </div>
                            @* 只有助手消息才显示反馈按钮，并且必须有有效的 ID *@
                            <div v-if="msg.roleType === 2 && msg.id && msg.id > 0" class="chat-message-feedback">
                                <el-button 
                                    :type="msg.userFeedback === true ? 'success' : 'text'" 
                                    :icon="msg.userFeedback === true ? 'el-icon-check' : 'el-icon-thumb'" 
                                    size="mini"
                                    @@click="toggleChatFeedback(msg.id, true)"
                                    title="点赞">
                                    <span v-if="msg.userFeedback === true">已点赞</span>
                                    <span v-else>点赞</span>
                                </el-button>
                                <el-button 
                                    :type="msg.userFeedback === false ? 'danger' : 'text'" 
                                    :icon="msg.userFeedback === false ? 'el-icon-close' : 'el-icon-remove-outline'" 
                                    size="mini"
                                    @@click="toggleChatFeedback(msg.id, false)"
                                    title="点踩">
                                    <span v-if="msg.userFeedback === false">已点踩</span>
                                    <span v-else>点踩</span>
                                </el-button>
                            </div>
                            @* 如果没有有效 ID，显示提示 *@
                            <div v-if="msg.roleType === 2 && (!msg.id || msg.id === 0)" class="chat-message-feedback" style="color: #909399; font-size: 12px;">
                                <i class="el-icon-loading"></i> 正在保存...
                            </div>
                        </div>
                    </div>
                </div>
            </el-form-item>
            @* 继续聊天模式下显示 SystemMessage（Prompt）*@
            <el-form-item v-if="continueChatMode" label="System Message">
                <el-collapse v-model="systemMessageCollapse">
                    <el-collapse-item name="systemMessage">
                        <template slot="title">
                            <i :class="systemMessageCollapse.includes('systemMessage') ? 'el-icon-arrow-up' : 'el-icon-arrow-down'" style="margin-right: 8px;"></i>
                            <span style="font-weight: 600;">System Message (Prompt)</span>
                            <span style="margin-left: 8px; font-size: 12px; color: #909399;">(点击{{ systemMessageCollapse.includes('systemMessage') ? '收起' : '展开' }}查看当前对话使用的 Prompt)</span>
                        </template>
                        <div class="system-message-content">
                            {{ continueChatSystemMessage || '加载中...' }}
                        </div>
                    </el-collapse-item>
                </el-collapse>
            </el-form-item>
            
            @* 对话模式下的对话输入区域 *@
            @* 注意：不使用 prop="chatInput"，因为这是条件显示的字段，resetFields 可能会出错 *@
            <el-form-item v-if="tacticalForm.chatMode === '对话模式'" label="对话输入">
                <el-input 
                    v-model="tacticalChatInput" 
                    type="textarea" 
                    :rows="6"
                    ref="tacticalChatInput"
                    @@keydown.native="handleChatInputKeydown"
                    :placeholder="continueChatMode ? '请输入您的下一句话... (Ctrl+Enter / Cmd+Enter 发送)' : '请输入您的问题... (Ctrl+Enter / Cmd+Enter 发送)'">
                </el-input>
                <div style="margin-top: 8px; font-size: 12px; color: #909399;">
                    {{ continueChatMode ? '输入内容将追加到现有对话中' : '输入内容将作为 userMessage 参数传递到后端接口' }}
                    <span style="margin-left: 8px; color: #909399;">快捷键：Ctrl+Enter (Windows) / Cmd+Enter (Mac)</span>
                </div>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button size="mini" @@click="tacticalFormVisible = false">取 消</el-button>
            @* v-loading="tacticalFormSubmitLoading" *@
            <el-button type="primary" size="mini" @@click="tacticalFormSubmitBtn">确 定</el-button>
        </div>
    </el-dialog>
    @*导图 dialog*@
    <el-dialog 
        title="3D 结构导图" 
        :visible.sync="mapDialogVisible" 
        width="90%"
        :close-on-click-modal="false"
        center 
        @@close="mapDialogClose">
        <div id="map3dContainer" style="width: 100%; height: 600px; background: #1a1a1a;"></div>
    </el-dialog>
    @*新增模型 dialog*@
    <el-dialog title="新增模型" :visible.sync="modelFormVisible" center @@close="modelFormCloseDialog">
        <el-form ref="modelForm" :model="modelForm" :rules="rules" label-position="left">
            <el-form-item label="模型类型" prop="modelType" label-width="130px">
                <el-select v-model="modelForm.modelType" placeholder="请选择模型类型">
                    <el-option v-for="(item,index) in modelTypeOpt" v-key="index" :label="item.label" :value="item.value" :disabled="item.disabled"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="模型别名" prop="alias" label-width="130px">
                <el-input v-model="modelForm.alias" autocomplete="off" placeholder="请输入模型别名"></el-input>
            </el-form-item>
            <el-form-item label="模型名称" prop="deploymentName" label-width="130px">
                <el-input v-model="modelForm.deploymentName" autocomplete="off" placeholder="请输入模型名称"></el-input>
            </el-form-item>
            <el-form-item v-if="modelForm.modelType==='16'||modelForm.modelType==='4'" label="API Version" prop="apiVersion" label-width="130px">
                <el-input v-model="modelForm.apiVersion" autocomplete="off" placeholder="请输入API Version"></el-input>
            </el-form-item>
            <el-form-item v-if="modelForm.modelType==='16'||modelForm.modelType==='8'||modelForm.modelType==='4'" label="API key" prop="apiKey" label-width="130px">
                <el-input v-model="modelForm.apiKey" show-password autocomplete="off" auto-complete="new-password" placeholder="请输入API key"></el-input>
            </el-form-item>
            <el-form-item v-if="modelForm.modelType==='16'||modelForm.modelType==='4'||modelForm.modelType==='32'" label="End Point" prop="endpoint" label-width="130px">
                <el-input v-model="modelForm.endpoint" autocomplete="off" placeholder="请输入End Point"></el-input>
            </el-form-item>
            <el-form-item v-if="modelForm.modelType==='8'" label="Organization Id" prop="organizationId" label-width="130px">
                <el-input v-model="modelForm.organizationId" autocomplete="off" placeholder="请输入Organization Id"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @@click="modelFormVisible = false">取 消</el-button>
            @* v-loading="modelFormSubmitLoading" *@
            <el-button type="primary" @@click="modelFormSubmitBtn">确 定</el-button>
        </div>
    </el-dialog>
    @*新增靶场 dialog*@
    <el-dialog title="新增靶场" :visible.sync="fieldFormVisible" center @@close="fieldFormCloseDialog">
        <el-form ref="fieldForm" :model="fieldForm" :rules="rules" label-position="left">
            <el-form-item label="靶场名称" prop="alias" label-width="130px">
                <el-input v-model="fieldForm.alias" autocomplete="off" placeholder="请输入靶场名称"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @@click="fieldFormVisible = false">取 消</el-button>
            <el-button type="primary" v-loading="fieldFormSubmitLoading" @@click="fieldFormSubmitBtn">确 定</el-button>
        </div>
    </el-dialog>
    @*ai评分标准 dialog @@close="aiScoreFormCloseDialog" *@
    <el-dialog title="AI 评分标准" :visible.sync="aiScoreFormVisible" center>
        <el-form ref="aiScoreForm" :model="aiScoreForm" :rules="rules" label-position="left">

            <div v-for="(item,index) in aiScoreForm.resultList" v-key="index" class="targetShootBtnRow">
                @* :rules="rules.aiResultVal" *@
                <el-form-item :label="`${item.label}${index+1}`" :prop="'resultList.' + index + '.value'" label-width="100px">
                    @* <el-input v-model="item.value" autocomplete="off" placeholder="请输入期望结果"></el-input> *@
                    @* resize="none"
                    maxlength="200"
                    show-word-limit *@
                    <el-input v-model="item.value" type="textarea" :rows="2" placeholder="请输入期望结果" style="width:430px;">
                    </el-input>
                </el-form-item>
                <i slot="reference" class="el-icon-delete deleteIcon" @@click="deleteAiScoreBtn(index)"></i>

            </div>
            <el-button type="primary" size="mini" icon="el-icon-plus" circle @@click="aiScoreFormAddRow"></el-button>
            <div class="warnRow" style="margin-top:20px;">注意：设置预期结果后，将会根据预期结果自动进行AI评分。</div>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @@click="aiScoreFormClose">关闭</el-button>
            @* v-loading="aiScoreFormSubmitLoading" *@
            @* <el-button type="primary" @@click="aiScoreFormSubmitBtn">保 存</el-button> *@
        </div>
    </el-dialog>
    @* 导入plugin *@
    <el-dialog title="导入 plugin 文件夹" :visible.sync="uploadPluginVisible" center @@close="uploadPluginCloseDialog">
        <div class="">
            @* 提示 *@
            <div class="tipsRow">
                可直接上传 OpenAI / Semantic Kernel 标准的 plugin 文件夹，自动生成靶场。（需选择选择整个 plugin 文件夹）
            </div>
            @* 拖拽区域  class="d-flex align-center justify-content-center" *@
            <div v-if="uploadPluginDropAreaVisible" class="el-upload-dragger" v-bind:class="{'is-dragover':uploadPluginDropHover}" @@drop="enentPluginDrop" @@dragover="pluginDropOverHandler" @@dragenter="pluginDropEnterHandler" @@dragleave="pluginDropLeaveHandler">
                <i class="el-icon-upload"></i>
                <div class="el-upload__text">
                    将文件夹拖到此处，或<em @@click="enentPluginInput">点击上传</em>
                </div>
            </div>
            @* 选择的文件夹中的文件列表 *@
            <div v-else>
                <el-button type="primary" size="mini" @@click="uploadPluginCloseDialog">重新上传</el-button>
                <el-table :data="uploadPluginData"
                          max-height="300"
                          style="width: 100%">
                    <el-table-column prop="name" label="文件名" width="200"></el-table-column>
                    <el-table-column prop="path" label="文件路径"></el-table-column>
                </el-table>
            </div>
        </div>
        <div slot="footer" class="dialog-footer">
            <el-button @@click="uploadPluginVisible = false">取 消</el-button>
            <el-button type="primary" @@click="submitUploadPlugins">上 传</el-button>
        </div>
    </el-dialog>
    @* 导出plugin *@
    <el-dialog title="导出 plugin 文件夹" :visible.sync="expectedPluginVisible" center @@close="expectedPluginCloseDialog">
        <el-form ref="expectedPluginFoem" :model="expectedPluginFoem" :rules="rules" label-position="left">
            @*             <el-form-item label="靶场" prop="rangeId" label-width="130px">
            <el-select v-model="expectedPluginFoem.rangeId" multiple
            collapse-tags placeholder="请选择靶场" class="selectRow" @@change="expectedPluginPromptFieldChange">
            <el-option v-for="item in promptFieldOpt"
            v-key="item.id"
            :label="item.label"
            :value="item.value"
            :disabled="item.disabled">
            </el-option>
            </el-select>
            </el-form-item> *@
            <el-form-item label="靶场和靶道" prop="checkList" label-width="130px">
                @* 操作按钮组 *@
                <div class="plugin-export-actions">
                    <div class="action-buttons">
                        <el-button size="mini" icon="el-icon-check" @@click="exportPluginSelectAll">全选</el-button>
                        <el-button size="mini" icon="el-icon-refresh-left" @@click="exportPluginInvertSelection">反选</el-button>
                        <el-button size="mini" icon="el-icon-close" @@click="exportPluginClearAll">清空</el-button>
                        <el-divider direction="vertical"></el-divider>
                        <el-button size="mini" :icon="exportPluginExpandAll ? 'el-icon-folder-opened' : 'el-icon-folder'" @@click="exportPluginToggleExpand">
                            {{exportPluginExpandAll ? '收起全部' : '展开全部'}}
                        </el-button>
                    </div>
                    <div class="selection-count">
                        <el-tag size="small" type="info">
                            已选择: <strong>{{exportPluginSelectedCount}}</strong> 个靶道
                        </el-tag>
                    </div>
                </div>
                @* 树形选择器 *@
                <div class="expectedPluginTreeBox">
                    <el-tree ref="expectedPluginTree" 
                             :data="expectedPluginFieldList" 
                             show-checkbox 
                             node-key="idkey" 
                             :props="defaultProps" 
                             :default-expand-all="exportPluginExpandAll"
                             @@check-change="treeCheckChange">
                    </el-tree>
                </div>
            </el-form-item>

        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @@click="expectedPluginVisible = false">取 消</el-button>
            <el-button type="primary" @@click="btnExpectedPlugins">确 认</el-button>
        </div>
    </el-dialog>
    <el-dialog title="设置靶道名称"
               :visible.sync="dialogVisible"
               width="30%"
              >
        <span>
            请选择或输入备注名称 
            <el-tooltip content="选择已存在的名称时，将把其名称转移到当前靶道，原靶道名称重置为“未设置”" placement="top">
                <i class="el-icon-info"></i>
            </el-tooltip>
        </span>
        <el-autocomplete class="inline-input" 
                         v-model="targetlaneName"
                         :fetch-suggestions="querySearch"
                         placeholder="请输入靶道备注名称"
                         value-key="label"
                         style="width:100%"
        @@select="handleSelect"></el-autocomplete>
        <span slot="footer" class="dialog-footer">
            <el-button @@click="dialogVisible = false">取 消</el-button>
            <el-button type="primary" @@click="confirmtargetlaneName">确 定</el-button>
        </span>
    </el-dialog>
    
    @* Prompt 对比对话框 *@
    <el-dialog title="对比 Prompt" 
               :visible.sync="compareDialogVisible" 
               width="90%" 
               top="5vh"
               class="prompt-compare-dialog"
               :close-on-click-modal="false">
        @* 选择对比的Prompt *@
        <div class="compare-selector">
            <el-select v-model="comparePromptAId" 
                       filterable 
                       placeholder="选择 Prompt A" 
                       @@change="loadComparePromptA"
                       style="width: 40%;">
                <el-option v-for="item in promptOpt"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
            
            <el-button type="text" 
                       icon="el-icon-sort" 
                       @@click="swapComparePrompts"
                       style="margin: 0 20px;">
                交换
            </el-button>
            
            <el-select v-model="comparePromptBId" 
                       filterable 
                       placeholder="选择 Prompt B" 
                       @@change="loadComparePromptB"
                       style="width: 40%;">
                <el-option v-for="item in promptOpt"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
        </div>
        
        @* 同一Prompt警告 *@
        <el-alert v-if="isSamePrompt" 
                  title="警告：您正在对比同一个 Prompt！" 
                  type="warning" 
                  :closable="false"
                  show-icon
                  style="margin-bottom: 15px;">
            <template slot>
                <p style="margin: 5px 0;">当前选择的两个 Prompt 是同一个（版本号: <strong>{{comparePromptA ? comparePromptA.fullVersion : ''}}</strong>）。</p>
                <p style="margin: 5px 0;">建议选择不同的 Prompt 进行对比以查看差异。</p>
            </template>
        </el-alert>
        
        @* 评分统计对比卡片 *@
        <div class="compare-score-cards" v-if="comparePromptA && comparePromptB">
            <div class="score-card">
                <div class="score-card-header">
                    <span class="score-card-title">📝 Prompt A</span>
                    <el-button type="primary" 
                               size="mini" 
                               icon="el-icon-position" 
                               @@click="switchToPrompt(comparePromptAId)">
                        跳转到此 Prompt
                    </el-button>
                </div>
                <div class="score-card-body">
                    <div class="score-item">
                        <span class="score-label">平均分:</span>
                        <span class="score-value" :class="{'score-empty': !hasScore(comparePromptA.evalAvgScore)}">
                            {{comparePromptA.evalAvgScore > -1 ? comparePromptA.evalAvgScore.toFixed(1) : '--'}}
                        </span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">最高分:</span>
                        <span class="score-value" :class="{'score-empty': !hasScore(comparePromptA.evalMaxScore)}">
                            {{comparePromptA.evalMaxScore > -1 ? comparePromptA.evalMaxScore.toFixed(1) : '--'}}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="score-card">
                <div class="score-card-header">
                    <span class="score-card-title">📝 Prompt B</span>
                    <el-button type="primary" 
                               size="mini" 
                               icon="el-icon-position" 
                               @@click="switchToPrompt(comparePromptBId)">
                        跳转到此 Prompt
                    </el-button>
                </div>
                <div class="score-card-body">
                    <div class="score-item">
                        <span class="score-label">平均分:</span>
                        <span class="score-value" :class="{'score-empty': !hasScore(comparePromptB.evalAvgScore)}">
                            {{comparePromptB.evalAvgScore > -1 ? comparePromptB.evalAvgScore.toFixed(1) : '--'}}
                        </span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">最高分:</span>
                        <span class="score-value" :class="{'score-empty': !hasScore(comparePromptB.evalMaxScore)}">
                            {{comparePromptB.evalMaxScore > -1 ? comparePromptB.evalMaxScore.toFixed(1) : '--'}}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        @* 对比内容区域 *@
        <div class="compare-content" v-if="comparePromptA && comparePromptB">
            @* 基本信息对比（紧凑型表格） *@
            <div class="compare-info-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 120px;">字段</th>
                            <th>
                                📝 Prompt A 
                                <span class="version-tag">{{comparePromptA.fullVersion}}</span>
                                <i class="el-icon-document-copy copy-version-icon" 
                                   @@click="copyInfo('A')"
                                   title="复制版本号"></i>
                            </th>
                            <th>
                                📝 Prompt B 
                                <span class="version-tag">{{comparePromptB.fullVersion}}</span>
                                <i class="el-icon-document-copy copy-version-icon" 
                                   @@click="copyInfo('B')"
                                   title="复制版本号"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr :class="{'has-diff': comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.targetRangeName !== comparePromptBInfo.targetRangeName}">
                            <td class="field-name">靶场</td>
                            <td>{{comparePromptAInfo ? comparePromptAInfo.targetRangeName : '--'}}</td>
                            <td>
                                {{comparePromptBInfo ? comparePromptBInfo.targetRangeName : '--'}}
                                <span class="diff-mark" v-if="comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.targetRangeName !== comparePromptBInfo.targetRangeName">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.targetLaneName !== comparePromptBInfo.targetLaneName}">
                            <td class="field-name">靶道</td>
                            <td>{{comparePromptAInfo ? comparePromptAInfo.targetLaneName : '--'}}</td>
                            <td>
                                {{comparePromptBInfo ? comparePromptBInfo.targetLaneName : '--'}}
                                <span class="diff-mark" v-if="comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.targetLaneName !== comparePromptBInfo.targetLaneName">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.tacticalName !== comparePromptBInfo.tacticalName}">
                            <td class="field-name">战术</td>
                            <td>{{comparePromptAInfo ? comparePromptAInfo.tacticalName : '--'}}</td>
                            <td>
                                {{comparePromptBInfo ? comparePromptBInfo.tacticalName : '--'}}
                                <span class="diff-mark" v-if="comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.tacticalName !== comparePromptBInfo.tacticalName">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.nickName, comparePromptB.nickName)}">
                            <td class="field-name">别名</td>
                            <td>{{comparePromptA.nickName || '--'}}</td>
                            <td>
                                {{comparePromptB.nickName || '--'}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.nickName, comparePromptB.nickName)">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.modelName !== comparePromptBInfo.modelName}">
                            <td class="field-name">模型</td>
                            <td>{{comparePromptAInfo ? comparePromptAInfo.modelName : '--'}}</td>
                            <td>
                                {{comparePromptBInfo ? comparePromptBInfo.modelName : '--'}}
                                <span class="diff-mark" v-if="comparePromptAInfo && comparePromptBInfo && comparePromptAInfo.modelName !== comparePromptBInfo.modelName">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.temperature, comparePromptB.temperature)}">
                            <td class="field-name">Temperature</td>
                            <td>{{comparePromptA.temperature}}</td>
                            <td>
                                {{comparePromptB.temperature}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.temperature, comparePromptB.temperature)">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.maxTokens, comparePromptB.maxTokens)}">
                            <td class="field-name">Max Tokens</td>
                            <td>{{comparePromptA.maxTokens}}</td>
                            <td>
                                {{comparePromptB.maxTokens}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.maxTokens, comparePromptB.maxTokens)">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.topP, comparePromptB.topP)}">
                            <td class="field-name">Top P</td>
                            <td>{{comparePromptA.topP}}</td>
                            <td>
                                {{comparePromptB.topP}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.topP, comparePromptB.topP)">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.presencePenalty, comparePromptB.presencePenalty)}">
                            <td class="field-name">Presence Penalty</td>
                            <td>{{comparePromptA.presencePenalty}}</td>
                            <td>
                                {{comparePromptB.presencePenalty}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.presencePenalty, comparePromptB.presencePenalty)">●</span>
                            </td>
                        </tr>
                        <tr :class="{'has-diff': hasFieldDiff(comparePromptA.frequencyPenalty, comparePromptB.frequencyPenalty)}">
                            <td class="field-name">Frequency Penalty</td>
                            <td>{{comparePromptA.frequencyPenalty}}</td>
                            <td>
                                {{comparePromptB.frequencyPenalty}}
                                <span class="diff-mark" v-if="hasFieldDiff(comparePromptA.frequencyPenalty, comparePromptB.frequencyPenalty)">●</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            @* Prompt内容对比（左右同步滚动，Git风格差异显示） *@
            <div class="compare-diff-section">
                <h4 class="diff-title">📄 Prompt 内容对比</h4>
                <div class="compare-diff-container" ref="compareScrollContainer">
                    <div class="compare-columns">
                        <div class="compare-diff-column">
                            <div class="diff-column-header">Prompt A</div>
                            <div class="diff-code-block">
                                <pre v-html="getContentDiffHtml('A')"></pre>
                            </div>
                        </div>
                        <div class="compare-diff-column">
                            <div class="diff-column-header">Prompt B  
                                <span class="diff-badge" v-if="hasFieldDiff(comparePromptA.promptContent, comparePromptB.promptContent)">有差异</span>
                            </div>
                            <div class="diff-code-block" :class="{'has-content-diff': hasFieldDiff(comparePromptA.promptContent, comparePromptB.promptContent)}">
                                <pre v-html="getContentDiffHtml('B')"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            @* 请求参数对比（前缀、后缀、变量配置） *@
            <div class="compare-diff-section">
                <h4 class="diff-title">🎯 请求参数对比</h4>
                
                @* 前缀和后缀对比（表格形式） *@
                <div class="compare-params-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 100px;">参数</th>
                                <th>Prompt A</th>
                                <th>Prompt B</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr :class="{'has-diff': hasFieldDiff(getPromptPrefix('A'), getPromptPrefix('B'))}">
                                <td class="field-name">前缀</td>
                                <td>
                                    <code>{{getPromptPrefix('A') || '(未设置)'}}</code>
                                </td>
                                <td>
                                    <code>{{getPromptPrefix('B') || '(未设置)'}}</code>
                                    <span class="diff-mark" v-if="hasFieldDiff(getPromptPrefix('A'), getPromptPrefix('B'))">●</span>
                                </td>
                            </tr>
                            <tr :class="{'has-diff': hasFieldDiff(getPromptSuffix('A'), getPromptSuffix('B'))}">
                                <td class="field-name">后缀</td>
                                <td>
                                    <code>{{getPromptSuffix('A') || '(未设置)'}}</code>
                                </td>
                                <td>
                                    <code>{{getPromptSuffix('B') || '(未设置)'}}</code>
                                    <span class="diff-mark" v-if="hasFieldDiff(getPromptSuffix('A'), getPromptSuffix('B'))">●</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                @* 变量列表对比（Git diff风格） *@
                <div class="compare-diff-container" v-if="comparePromptA.variablesJson || comparePromptB.variablesJson">
                    <div class="compare-columns">
                        <div class="compare-diff-column">
                            <div class="diff-column-header">Prompt A - 变量配置</div>
                            <div class="diff-code-block">
                                <pre v-html="getVariablesDiffHtml('A')"></pre>
                            </div>
                        </div>
                        <div class="compare-diff-column">
                            <div class="diff-column-header">Prompt B - 变量配置
                                <span class="diff-badge" v-if="hasFieldDiff(comparePromptA.variablesJson, comparePromptB.variablesJson)">有差异</span>
                            </div>
                            <div class="diff-code-block" :class="{'has-content-diff': hasFieldDiff(comparePromptA.variablesJson, comparePromptB.variablesJson)}">
                                <pre v-html="getVariablesDiffHtml('B')"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="compare-empty-params">
                    <i class="el-icon-info"></i>
                    <span>两个Prompt都未配置变量</span>
                </div>
            </div>
        </div>
        
        @* 空状态提示 *@
        <div v-else class="compare-empty-state">
            <i class="el-icon-document-copy" style="font-size: 60px; color: #dcdfe6;"></i>
            <p>请选择两个 Prompt 进行对比</p>
        </div>
        
        <div slot="footer" class="dialog-footer">
            <el-button @@click="compareDialogVisible = false">关闭</el-button>
        </div>
    </el-dialog>
    
</div>


<div v-if="isPageLoading" class="promptLoaderBox">
    <div class="loading">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>

@section scripts {
    <script src="~/js/PromptRange/lib/axios.min.js"></script>
    <script src="~/js/PromptRange/lib/jszip.min.js"></script>
    <script src="~/js/PromptRange/lib/fileSave.min.js"></script>
    <script src="~/js/PromptRange/lib/marked.min.js"></script>
    <script src="~/js/PromptRange/lib/diff.min.js"></script>
    <script src="~/js/PromptRange/echarts/echarts.min.js"></script>
    <script src="~/js/PromptRange/echarts/echarts-gl.min.js"></script>
    <script src="~/js/PromptRange/lib/three.min.js"></script>
    <script src="~/js/PromptRange/lib/OrbitControls.js"></script>
    <script src="~/js/PromptRange/axios.js"></script>
    
    @* PromptRange 工具类库 - 必须在 prompt.js 之前加载 *@
    <script src="~/js/PromptRange/utils/htmlHelper.js"></script>
    <script src="~/js/PromptRange/utils/dateHelper.js"></script>
    <script src="~/js/PromptRange/utils/nameHelper.js"></script>
    <script src="~/js/PromptRange/utils/storageHelper.js"></script>
    <script src="~/js/PromptRange/utils/copyHelper.js"></script>
    @* ApiHelper 暂不使用，项目已有 servicePR (axios) *@
    @* <script src="~/js/PromptRange/utils/apiHelper.js"></script> *@
    
    <script src="~/js/PromptRange/prompt.js"></script>
}