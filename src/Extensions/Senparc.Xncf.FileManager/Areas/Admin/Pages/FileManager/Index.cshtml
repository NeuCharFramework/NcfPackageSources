@page
@model Senparc.Xncf.FileManager.Areas.FileManager.Pages.Index
@{
    ViewData["Title"] = "FileManager 首页";
    Layout = "_Layout_Vue";
}

@section breadcrumbs{
    <el-breadcrumb-item>扩展模块</el-breadcrumb-item>
    <el-breadcrumb-item>文件管理</el-breadcrumb-item>
    <el-breadcrumb-item>首页</el-breadcrumb-item>
}

@section style{
    <style>
        .hidden {display:none;}
        .layout { display:flex; gap:16px; }
        .folder-panel { width:260px; }
        .content-panel { flex:1; }
        .folder-breadcrumb { margin: 6px 0 12px; }
    </style>
}

<div class="layout">
    <div class="folder-panel">
        <el-card shadow="never">
            <div slot="header" class="clearfix">
                <span>文件夹</span>
                <el-button style="float: right; padding: 3px 6px" type="text" @@click="showCreateFolderDialog">新建</el-button>
            </div>

            <el-tree
                ref="folderTree"
                :data="folderTree"
                :props="folderTreeProps"
                node-key="id"
                lazy
                :load="loadFolderChildren"
                highlight-current
                :expand-on-click-node="false"
                @@node-click="onFolderNodeClick">
                <span class="custom-tree-node" slot-scope="{ node, data }">
                    <i class="el-icon-folder"></i>
                    <span style="margin-left:6px;">{{ data.name }}</span>
                </span>
            </el-tree>
        </el-card>
    </div>

    <div class="content-panel">
        <div class="filter-container">
            <el-button type="primary" icon="el-icon-upload" size="small" @@click="showUploadDialog">上传文件</el-button>
            <el-button size="small" @@click="reloadFolderTree">刷新文件夹</el-button>
        </div>

        <div class="folder-breadcrumb">
            <el-breadcrumb separator="/">
                <el-breadcrumb-item>
                    <a href="javascript:void(0)" @@click="enterFolder(null)">根目录</a>
                </el-breadcrumb-item>
                <el-breadcrumb-item v-for="p in folderPath" :key="p.id">
                    <a href="javascript:void(0)" @@click="enterFolder(p.id)">{{p.name}}</a>
                </el-breadcrumb-item>
            </el-breadcrumb>
        </div>

        <el-table :data="tableData" v-loading="tableLoading" border>
            <el-table-column prop="id" label="表Id" width="auto" class-name="hidden"></el-table-column>
            <el-table-column prop="fileName" label="文件名" width="auto"></el-table-column>
            <el-table-column prop="fileSize" label="大小" width="120">
                <template slot-scope="scope">
                    {{ formatFileSize(scope.row.fileSize) }}
                </template>
            </el-table-column>
            <el-table-column prop="fileType" label="类型" width="100">
                <template slot-scope="scope">
                    <span v-if="scope.row.fileType===1">文本</span>
                    <span v-else-if="scope.row.fileType===2">Word</span>
                    <span v-else-if="scope.row.fileType===3">PowerPoint</span>
                    <span v-else-if="scope.row.fileType===4">Excel</span>
                    <span v-else-if="scope.row.fileType===5">代码</span>
                    <span v-else>其他</span>
                </template>
            </el-table-column>
            <el-table-column prop="description" label="备注" width="auto">
                <template slot-scope="scope">
                    <el-input v-model="scope.row.description" @@blur="handleNoteChange(scope.row)" size="small"></el-input>
                </template>
            </el-table-column>
            <el-table-column prop="uploadTime" label="上传时间" width="180">
                <template slot-scope="scope">
                    {{ dateFormatter(scope.row.uploadTime) }}
                </template>
            </el-table-column>
            <el-table-column label="操作" width="220">
                <template slot-scope="scope">
                    <el-button type="primary" size="mini" @@click="downloadFile(scope.row)">下载</el-button>
                    <el-button type="danger" size="mini" @@click="deleteFile(scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>

        <div class="pagination-container">
            <el-pagination
                @@current-change="handleCurrentChange"
                @@size-change="handleSizeChange"
                :current-page="page.page"
                :page-sizes="[10, 20, 30, 40]"
                :page-size="page.size"
                layout="sizes, prev, pager, next"
                :total="total">
            </el-pagination>
        </div>
    </div>

    <el-dialog title="上传文件" :visible.sync="uploadDialog.visible" width="500px">
        <el-upload
            class="upload-demo"
            ref="upload"
            action="#"
            :auto-upload="false"
            :multiple="true"
            :show-file-list="true"
            :on-success="handleUploadSuccess"
            :on-error="handleUploadError"
            :on-change="handleFileChange"
            :on-progress="handleProgress"
            :before-upload="beforeUpload"
            :file-list="uploadDialog.fileList">
            <el-button slot="trigger" size="small" type="primary">选择文件</el-button>
            <div slot="tip" class="el-upload__tip">可以选择多个文件同时上传</div>
        </el-upload>
        <div style="margin-top:8px;">
            <el-alert type="info" show-icon title="上传到：" :description="currentFolderId? ('文件夹 #'+currentFolderId) : '根目录'"></el-alert>
        </div>

        <div v-for="file in uploadDialog.fileList" :key="file.uid" style="margin-top: 10px;">
            <el-input v-model="file.description" :placeholder="'请输入' + file.name + '的备注'" size="small">
                <template slot="prepend">{{file.name}}</template>
            </el-input>
        </div>

        <span slot="footer" class="dialog-footer">
            <el-button @@click="cancelUpload">取 消</el-button>
            <el-button type="primary" @@click="submitUpload" :loading="uploadDialog.uploading">确 定</el-button>
        </span>
    </el-dialog>

    <el-dialog title="新建文件夹" :visible.sync="createFolderDialog.visible" width="420px">
        <el-form :model="createFolderDialog.form" label-width="80px">
            <el-form-item label="名称">
                <el-input v-model="createFolderDialog.form.name" placeholder="请输入文件夹名称"></el-input>
            </el-form-item>
            <el-form-item label="备注">
                <el-input type="textarea" v-model="createFolderDialog.form.description" placeholder="备注（可选）" rows="3"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @@click="createFolderDialog.visible=false">取 消</el-button>
            <el-button type="primary" @@click="submitCreateFolder" :loading="createFolderDialog.loading">确 定</el-button>
        </span>
    </el-dialog>
</div>

@section scripts{
    <script>
        new Vue({
            el: "#app",
            data: function () {
                return {
                    tableData: [],
                    tableLoading: false,
                    page: { page: 1, size: 10 },
                    total: 0,
                    currentFolderId: null,
                    folderPath: [],
                    folderTree: [{ id: null, name: '根目录', hasChildren: true }],
                    folderTreeProps: {
                        label: 'name',
                        children: 'children',
                        isLeaf: function (data) { return data && data.hasChildren === false; }
                    },
                    uploadDialog: { visible: false, fileList: [], uploading: false },
                    createFolderDialog: { visible: false, loading: false, form: { name: '', description: '' } }
                };
            },
            created: function () {
                this.getList();
            },
            methods: {
                dateFormatter: function (date) {
                    return new Date(date).toLocaleString();
                },
                formatFileSize: function (size) {
                    var units = ['B', 'KB', 'MB', 'GB'];
                    var index = 0;
                    while (size >= 1024 && index < units.length - 1) {
                        size = size / 1024;
                        index++;
                    }
                    return size.toFixed(2) + ' ' + units[index];
                },
                getList: async function () {
                    this.tableLoading = true;
                    try {
                        var url = '/Admin/FileManager/Index?handler=List&page=' + this.page.page + '&pageSize=' + this.page.size;
                        if (this.currentFolderId != null) {
                            url += '&folderId=' + this.currentFolderId;
                        }
                        var res = await axios.get(url);
                        this.tableData = res.data.data;
                        this.total = res.data.data.totalCount;
                    } finally {
                        this.tableLoading = false;
                    }
                },
                handleCurrentChange: function (val) {
                    this.page.page = val;
                    this.getList();
                },
                handleSizeChange: function (val) {
                    this.page.size = val;
                    this.page.page = 1;
                    this.getList();
                },
                loadFolderChildren: async function (node, resolve) {
                    try {
                        var parentId = node.level === 0 ? null : node.data.id;
                        var url = '/Admin/FileManager/Index?handler=Folders';
                        if (parentId != null) {
                            url += '&parentId=' + parentId;
                        }
                        var res = await axios.get(url);
                        var list = (res.data && res.data.data) ? res.data.data : (res.data || []);
                        resolve((list || []).map(function (f) {
                            return {
                                id: f.id,
                                name: f.name,
                                description: f.description,
                                parentId: f.parentId,
                                hasChildren: true
                            };
                        }));
                    } catch (e) {
                        console.error(e);
                        resolve([]);
                    }
                },
                onFolderNodeClick: function (data) {
                    this.enterFolder(data.id === null ? null : data.id);
                },
                enterFolder: async function (id) {
                    this.currentFolderId = id;
                    this.page.page = 1;
                    await this.getList();
                    await this.buildFolderPath(id);
                },
                buildFolderPath: async function (id) {
                    if (id == null) {
                        this.folderPath = [];
                        return;
                    }
                    if (!this.$refs.folderTree || typeof this.$refs.folderTree.getNode !== 'function') {
                        this.folderPath = [];
                        return;
                    }
                    var node = this.$refs.folderTree.getNode(id);
                    if (!node) {
                        this.folderPath = [];
                        return;
                    }
                    var path = [];
                    var cur = node;
                    while (cur && cur.data && cur.data.id !== null) {
                        path.unshift({ id: cur.data.id, name: cur.data.name });
                        cur = cur.parent;
                    }
                    this.folderPath = path;
                },
                reloadFolderTree: function () {
                    var self = this;
                    this.folderTree = [{ id: null, name: '根目录', hasChildren: true }];
                    this.$nextTick(function () {
                        if (self.$refs.folderTree && typeof self.$refs.folderTree.setCurrentKey === 'function') {
                            self.$refs.folderTree.setCurrentKey(self.currentFolderId);
                        }
                    });
                },
                handleNoteChange: async function (row) {
                    try {
                        await axios.post('/Admin/FileManager/Index?handler=EditNote', { id: row.id, note: row.description });
                        this.$message.success('更新成功');
                    } catch {
                        this.$message.error('更新失败');
                    }
                },
                deleteFile: async function (row) {
                    try {
                        await this.$confirm('确认删除该文件?', '提示', { type: 'warning' });
                        await axios.post('/Admin/FileManager/Index?handler=Delete&id=' + row.id);
                        this.$message.success('删除成功');
                        this.getList();
                    } catch {
                        this.$message.error('删除失败');
                    }
                },
                downloadFile: function (row) {
                    window.open('/Admin/FileManager/Index?handler=Download&id=' + row.id);
                },
                showUploadDialog: function () {
                    this.uploadDialog.visible = true;
                    this.uploadDialog.fileList = [];
                },
                handleFileChange: function (file, fileList) {
                    if (!file.description) {
                        this.$set(file, 'description', '');
                    }
                    this.uploadDialog.fileList = fileList;
                },
                handleProgress: function () { },
                beforeUpload: function () {
                    return false;
                },
                submitUpload: async function () {
                    if (this.uploadDialog.fileList.length === 0) {
                        this.$message.warning('请选择要上传的文件');
                        return;
                    }

                    this.uploadDialog.uploading = true;
                    try {
                        var formData = new FormData();
                        this.uploadDialog.fileList.forEach(function (file) {
                            formData.append('files', file.raw);
                            formData.append('descriptions', file.description || '');
                        });
                        if (this.currentFolderId != null) {
                            formData.append('folderId', this.currentFolderId);
                        }

                        await axios.post('/Admin/FileManager/Index?handler=Upload', formData, { headers: { 'Content-Type': 'multipart/form-data' } });

                        this.$message.success('上传成功');
                        this.uploadDialog.visible = false;
                        this.getList();
                    } catch (error) {
                        this.$message.error('上传失败：' + (error && error.message ? error.message : ''));
                    } finally {
                        this.uploadDialog.uploading = false;
                    }
                },
                cancelUpload: function () {
                    this.uploadDialog.visible = false;
                },
                showCreateFolderDialog: function () {
                    this.createFolderDialog.visible = true;
                    this.createFolderDialog.form = { name: '', description: '' };
                },
                submitCreateFolder: async function () {
                    if (!this.createFolderDialog.form.name) {
                        this.$message.warning('请输入文件夹名称');
                        return;
                    }
                    this.createFolderDialog.loading = true;
                    try {
                        await axios.post('/Admin/FileManager/Index?handler=CreateFolder', {
                            name: this.createFolderDialog.form.name,
                            description: this.createFolderDialog.form.description || '',
                            parentId: this.currentFolderId
                        });
                        this.$message.success('创建成功');
                        this.createFolderDialog.visible = false;
                        this.reloadFolderTree();
                    } catch (e) {
                        console.error(e);
                        this.$message.error('创建失败');
                    } finally {
                        this.createFolderDialog.loading = false;
                    }
                },
                handleUploadSuccess: function () { },
                handleUploadError: function (err) {
                    var msg = err && err.message ? err.message : (err ? String(err) : '');
                    this.$message.error('上传失败：' + msg);
                }
            }
        });
    </script>
}
