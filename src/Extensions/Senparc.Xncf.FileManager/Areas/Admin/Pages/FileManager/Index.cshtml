@page
@model Senparc.Xncf.FileManager.Areas.FileManager.Pages.Index
@{
    ViewData["Title"] = "FileManager 首页";
    Layout = "_Layout_Vue";
}

@section breadcrumbs{
    <el-breadcrumb-item>扩展模块</el-breadcrumb-item>
    <el-breadcrumb-item>文件管理</el-breadcrumb-item>
    <el-breadcrumb-item>首页</el-breadcrumb-item>
}

@section style{
    <style>
        .hidden {display:none;}
        .layout { display:flex; gap:16px; }
        .folder-panel { width:260px; }
        .content-panel { flex:1; }
    </style>
}

<div class="layout">
    <!-- 文件夹侧边栏 -->
    <div class="folder-panel">
        <el-card shadow="never">
            <div slot="header" class="clearfix">
                <span>文件夹</span>
                <el-button style="float: right; padding: 3px 6px" type="text" @@click="showCreateFolderDialog">新建</el-button>
            </div>
            <el-menu :default-active="String(currentFolderId ?? 'root')" class="el-menu-vertical-demo">
                <el-menu-item index="root" @@click="enterFolder(null)">
                    <i class="el-icon-folder"></i>
                    <span slot="title">根目录</span>
                </el-menu-item>
                <el-menu-item v-for="f in folders" :key="f.id" :index="String(f.id)" @@click="enterFolder(f.id)">
                    <i class="el-icon-folder"></i>
                    <span slot="title">{{f.name}}</span>
                </el-menu-item>
            </el-menu>
        </el-card>
    </div>

    <div class="content-panel">
        <div class="filter-container">
            <el-button type="primary" icon="el-icon-upload" size="small" @@click="showUploadDialog">上传文件</el-button>
            <el-button size="small" @@click="refreshFolders">刷新文件夹</el-button>
        </div>

        <el-table :data="tableData" v-loading="tableLoading" border>
            <el-table-column prop="id" label="表Id" width="auto" class-name="hidden"></el-table-column>
            <el-table-column prop="fileName" label="文件名" width="auto"></el-table-column>
            <el-table-column prop="fileSize" label="大小" width="120">
                <template slot-scope="scope">
                    {{ formatFileSize(scope.row.fileSize) }}
                </template>
            </el-table-column>
            <el-table-column prop="fileType" label="类型" width="100">
                <template slot-scope="scope">
                    <span v-if="scope.row.fileType===1">文本</span>
                    <span v-else-if="scope.row.fileType===2">Word</span>
                    <span v-else-if="scope.row.fileType===3">PowerPoint</span>
                    <span v-else-if="scope.row.fileType===4">Excel</span>
                    <span v-else-if="scope.row.fileType===5">代码</span>
                    <span v-else>其他</span>
                </template>
            </el-table-column>
            <el-table-column prop="description" label="备注" width="auto">
                <template slot-scope="scope">
                    <el-input v-model="scope.row.description" 
                             @@blur="handleNoteChange(scope.row)"
                             size="small">
                    </el-input>
                </template>
            </el-table-column>
            <el-table-column prop="uploadTime" label="上传时间" width="180">
                <template slot-scope="scope">
                    {{ dateFormatter(scope.row.uploadTime) }}
                </template>
            </el-table-column>
            <el-table-column label="操作" width="220">
                <template slot-scope="scope">
                    <el-button type="primary" size="mini" @@click="downloadFile(scope.row)">下载</el-button>
                    <el-button type="danger" size="mini" @@click="deleteFile(scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>

        <div class="pagination-container">
            <el-pagination
                @@current-change="handleCurrentChange"
                @@size-change="handleSizeChange"
                :current-page="page.page"
                :page-sizes="[10, 20, 30, 40]"
                :page-size="page.size"
                layout="sizes, prev, pager, next"
                :total="total">
            </el-pagination>
        </div>
    </div>

    <!-- 上传对话框 -->
    <el-dialog title="上传文件" :visible.sync="uploadDialog.visible" width="500px">
        <el-upload
            class="upload-demo"
            ref="upload"
            action="#"
            :auto-upload="false"
            :multiple="true"
            :show-file-list="true"
            :on-success="handleUploadSuccess"
            :on-error="handleUploadError"
            :on-change="handleFileChange"
            :on-progress="handleProgress"
            :before-upload="beforeUpload"
            :file-list="uploadDialog.fileList"
            >
            <el-button slot="trigger" size="small" type="primary">选择文件</el-button>
            <div slot="tip" class="el-upload__tip">可以选择多个文件同时上传</div>
        </el-upload>
        <div style="margin-top:8px;">
            <el-alert type="info" show-icon title="上传到：" :description="currentFolderId? ('文件夹 #'+currentFolderId) : '根目录'" ></el-alert>
        </div>
        
        <div v-for="(file, index) in uploadDialog.fileList" :key="file.uid" style="margin-top: 10px;">
            <el-input
                v-model="file.description"
                :placeholder="'请输入' + file.name + '的备注'"
                size="small">
                <template slot="prepend">{{file.name}}</template>
            </el-input>
        </div>

        <span slot="footer" class="dialog-footer">
            <el-button @@click="cancelUpload">取 消</el-button>
            <el-button type="primary" @@click="submitUpload" :loading="uploadDialog.uploading">确 定</el-button>
        </span>
    </el-dialog>

    <!-- 新建文件夹对话框 -->
    <el-dialog title="新建文件夹" :visible.sync="createFolderDialog.visible" width="420px">
        <el-form :model="createFolderDialog.form" label-width="80px">
            <el-form-item label="名称">
                <el-input v-model="createFolderDialog.form.name" placeholder="请输入文件夹名称"></el-input>
            </el-form-item>
            <el-form-item label="备注">
                <el-input type="textarea" v-model="createFolderDialog.form.description" placeholder="备注（可选）" rows="3"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @@click="createFolderDialog.visible=false">取 消</el-button>
            <el-button type="primary" @@click="submitCreateFolder" :loading="createFolderDialog.loading">确 定</el-button>
        </span>
    </el-dialog>
</div>

@section scripts{
    <script>
        new Vue({
            el: "#app",
            data() {
                return {
                    tableData: [],
                    tableLoading: false,
                    page: {
                        page: 1,
                        size: 10
                    },
                    total: 0,
                    currentFolderId: null,
                    folders: [],
                    uploadDialog: {
                        visible: false,
                        fileList: [],
                        uploading: false
                    },
                    createFolderDialog: {
                        visible: false,
                        loading: false,
                        form: { name: '', description: '' }
                    }
                }
            },
            created() {
                this.refreshFolders();
                this.getList();
            },
            methods: {
                dateFormatter(date) {
                    return new Date(date).toLocaleString()
                },
                formatFileSize(size) {
                    const units = ['B', 'KB', 'MB', 'GB']
                    let index = 0
                    while (size >= 1024 && index < units.length - 1) {
                        size /= 1024
                        index++
                    }
                    return `${size.toFixed(2)} ${units[index]}`
                },
                async getList() {
                    this.tableLoading = true
                    try {
                        const res = await axios.get(`/Admin/FileManager/Index?handler=List&page=${this.page.page}&pageSize=${this.page.size}` + (this.currentFolderId!=null?`&folderId=${this.currentFolderId}`:''))
                        this.tableData = res.data.data
                        this.total = res.data.data.totalCount
                    } finally {
                        this.tableLoading = false
                    }
                },
                handleCurrentChange(val) {
                    this.page.page = val
                    this.getList()
                },
                handleSizeChange(val) {
                    this.page.size = val
                    this.page.page = 1
                    this.getList()
                },
                async refreshFolders(){
                    try{
                        const res = await axios.get(`/Admin/FileManager/Index?handler=Folders` + (this.currentFolderId!=null?`&parentId=${this.currentFolderId}`:''))
                        this.folders = res.data.data || res.data
                    }catch(e){
                        console.error(e)
                    }
                },
                enterFolder(id){
                    this.currentFolderId = id
                    this.page.page = 1
                    this.getList()
                    this.refreshFolders()
                },
                handleUploadSuccess(response, file, fileList) {
                    // 由于我们使用手动上传，这个方法可以留空
                },
                handleUploadError(err, file, fileList) {
                    this.$message.error('上传失败：' + err.message);
                },
                async handleNoteChange(row) {
                    try {
                        await axios.post('/Admin/FileManager/Index?handler=EditNote', {
                            id: row.id,
                            note: row.description
                        })
                        this.$message.success('更新成功')
                    } catch {
                        this.$message.error('更新失败')
                    }
                },
                async deleteFile(row) {

                    try {
                        await this.$confirm('确认删除该文件?', '提示', {
                            type: 'warning'
                        })
                        await axios.post("@Model.DelFileUrl" + `?id=${row.id}`)
                        this.$message.success('删除成功')
                        this.getList()
                    } catch {
                        this.$message.error('删除失败')
                    }
                },
                downloadFile(row) {
                    window.open(`/Admin/FileManager/Index?handler=Download&id=${row.id}`)
                },
                showUploadDialog() {
                    this.uploadDialog.visible = true;
                    this.uploadDialog.fileList = [];
                },
                handleFileChange(file, fileList) {
                    if (!file.description) {
                        this.$set(file, 'description', '');
                    }
                    this.uploadDialog.fileList = fileList;
                },
                handleProgress(){},
                beforeUpload(file) {
                    return false;
                },
                async submitUpload() {
                    if (this.uploadDialog.fileList.length === 0) {
                        this.$message.warning('请选择要上传的文件');
                        return;
                    }

                    this.uploadDialog.uploading = true;
                    try {
                        const formData = new FormData();
                        this.uploadDialog.fileList.forEach((file, index) => {
                            formData.append('files', file.raw);
                            formData.append('descriptions', file.description || '');
                        });
                        if(this.currentFolderId!=null){
                            formData.append('folderId', this.currentFolderId);
                        }

                        const response = await axios.post("@Model.UpFileUrl", 
                            formData,
                            {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            }
                        )

                        this.$message.success('上传成功');
                        this.uploadDialog.visible = false;
                        this.getList();
                    } catch (error) {
                        this.$message.error('上传失败：' + error.message);
                    } finally {
                        this.uploadDialog.uploading = false;
                    }
                },
                cancelUpload() {
                    this.uploadDialog.visible = false;
                },
                showCreateFolderDialog(){
                    this.createFolderDialog.visible = true
                    this.createFolderDialog.form = { name:'', description:'' }
                },
                async submitCreateFolder(){
                    if(!this.createFolderDialog.form.name){
                        this.$message.warning('请输入文件夹名称')
                        return
                    }
                    this.createFolderDialog.loading = true
                    try{
                        const form = new FormData()
                        form.append('name', this.createFolderDialog.form.name)
                        form.append('description', this.createFolderDialog.form.description || '')
                        if(this.currentFolderId!=null){
                            form.append('parentId', this.currentFolderId)
                        }
                        await axios.post('/Admin/FileManager/Index?handler=CreateFolder', form)
                        this.$message.success('创建成功')
                        this.createFolderDialog.visible = false
                        this.refreshFolders()
                    }catch(e){
                        console.error(e)
                        this.$message.error('创建失败')
                    }finally{
                        this.createFolderDialog.loading = false
                    }
                }
            }
        })
    </script>
}
