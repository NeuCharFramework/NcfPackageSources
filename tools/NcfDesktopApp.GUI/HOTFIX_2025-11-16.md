# Hotfix - ä¿®å¤è¿›ç¨‹æµæ“ä½œå†²çªé”™è¯¯

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Cannot mix synchronous and asynchronous operation on process stream.
```

**å‡ºç°åœºæ™¯**ï¼š
å¯åŠ¨ NCF è¿›ç¨‹æ—¶ç«‹å³æŠ›å‡ºæ­¤å¼‚å¸¸ï¼Œå¯¼è‡´åº”ç”¨æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚

## ğŸ” é—®é¢˜åŸå› 

åœ¨ `AttachProcessOutputHandlers` æ–¹æ³•ä¸­ï¼ŒåŒæ—¶ä½¿ç”¨äº†ï¼š
1. `process.StandardOutput.BaseStream.ReadTimeout = 1000`ï¼ˆåŒæ­¥æµæ“ä½œï¼‰
2. `process.BeginOutputReadLine()`ï¼ˆå¼‚æ­¥äº‹ä»¶å¤„ç†ï¼‰

.NET çš„ Process ç±»ä¸å…è®¸åœ¨åŒä¸€ä¸ªæµä¸Šæ··åˆä½¿ç”¨åŒæ­¥å’Œå¼‚æ­¥æ“ä½œã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`Services/NcfService.cs`

**åˆ é™¤çš„ä»£ç **ï¼ˆç¬¬ 950-957 è¡Œï¼‰ï¼š
```csharp
try
{
    // è®¾ç½®ç¼–ç ä¸º UTF-8 é¿å…ä¸­æ–‡ä¹±ç 
    process.StandardOutput.BaseStream.ReadTimeout = 1000;
    process.StandardError.BaseStream.ReadTimeout = 1000;
}
catch 
{ 
    // æŸäº›è¿›ç¨‹å¯èƒ½ä¸æ”¯æŒè¶…æ—¶è®¾ç½®
}
```

**åŸå› **ï¼š
- `ReadTimeout` è®¾ç½®ä¼šæ ‡è®°æµä¸ºåŒæ­¥æ¨¡å¼
- `BeginOutputReadLine()` éœ€è¦çº¯å¼‚æ­¥æ¨¡å¼
- ä¸¤è€…å†²çªå¯¼è‡´å¼‚å¸¸

## ğŸ“Š ä¿®å¤éªŒè¯

ä¿®å¤åçš„ä»£ç ï¼š
```csharp
private void AttachProcessOutputHandlers(Process? process)
{
    if (process == null) return;
    
    // ç›´æ¥æ³¨å†Œäº‹ä»¶å¤„ç†ï¼Œä¸è®¾ç½® ReadTimeout
    process.OutputDataReceived += (sender, args) => { ... };
    process.ErrorDataReceived += (sender, args) => { ... };
    
    // å¼€å§‹å¼‚æ­¥è¯»å–
    process.BeginOutputReadLine();
    process.BeginErrorReadLine();
    
    // ...
}
```

## âœ… æµ‹è¯•ç¡®è®¤

- [ ] NCF è¿›ç¨‹èƒ½å¤ŸæˆåŠŸå¯åŠ¨
- [ ] CLI è¾“å‡ºæ­£å¸¸æ˜¾ç¤ºåœ¨ UI æ—¥å¿—ä¸­
- [ ] ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸ï¼ˆUTF-8 ç¼–ç åœ¨ startInfo ä¸­è®¾ç½®ï¼‰
- [ ] æ— å¼‚å¸¸æŠ›å‡º

## ğŸ“ ç»éªŒæ•™è®­

### âŒ é”™è¯¯åšæ³•
```csharp
// ä¸è¦è¿™æ ·åšï¼ä¼šå¯¼è‡´æ··åˆæ“ä½œé”™è¯¯
process.StandardOutput.BaseStream.ReadTimeout = 1000;
process.BeginOutputReadLine(); // â† å†²çªï¼
```

### âœ… æ­£ç¡®åšæ³•
```csharp
// åªä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥æ–¹å¼
process.OutputDataReceived += handler;
process.BeginOutputReadLine(); // âœ“ çº¯å¼‚æ­¥
```

### ğŸ¯ å…³é”®è¦ç‚¹

1. **é€‰æ‹©ä¸€ç§æ–¹å¼**ï¼šè¦ä¹ˆåŒæ­¥ï¼Œè¦ä¹ˆå¼‚æ­¥ï¼Œä¸èƒ½æ··åˆ
2. **äº‹ä»¶é©±åŠ¨æ›´å¥½**ï¼šå®æ—¶æ€§å¥½ï¼Œä¸é˜»å¡ï¼Œæ¨èç”¨äº CLI è¾“å‡ºæ•è·
3. **ç¼–ç è®¾ç½®ä½ç½®**ï¼šåœ¨ `ProcessStartInfo` ä¸­è®¾ç½®ï¼Œè€Œéåœ¨è¿è¡Œæ—¶è®¾ç½®
4. **ReadTimeout éå¿…éœ€**ï¼šäº‹ä»¶é©±åŠ¨æ–¹å¼ä¸éœ€è¦è¶…æ—¶æ§åˆ¶

## ğŸ”§ ç›¸å…³é…ç½®

### UTF-8 ç¼–ç è®¾ç½®ï¼ˆæ­£ç¡®ä½ç½®ï¼‰

åœ¨åˆ›å»º `ProcessStartInfo` æ—¶è®¾ç½®ï¼ˆå·²åœ¨ä»£ç ä¸­æ­£ç¡®å®ç°ï¼‰ï¼š
```csharp
var startInfo = new ProcessStartInfo
{
    // ...
    RedirectStandardOutput = true,
    RedirectStandardError = true,
    StandardOutputEncoding = System.Text.Encoding.UTF8, // â† åœ¨è¿™é‡Œè®¾ç½®
    StandardErrorEncoding = System.Text.Encoding.UTF8
};
```

## ğŸ“… ä¿®å¤ä¿¡æ¯

- **ä¿®å¤æ—¥æœŸ**ï¼š2025-11-16
- **ä¿®å¤äººå‘˜**ï¼šAI Assistant
- **å½±å“èŒƒå›´**ï¼šServices/NcfService.cs
- **ä¿®å¤ç±»å‹**ï¼šHotfixï¼ˆç´§æ€¥ä¿®å¤ï¼‰
- **æµ‹è¯•çŠ¶æ€**ï¼šç­‰å¾…ç”¨æˆ·éªŒè¯

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [CLI_OUTPUT_IMPLEMENTATION_SUMMARY.md](./CLI_OUTPUT_IMPLEMENTATION_SUMMARY.md) - åŠŸèƒ½å®ç°æ€»ç»“
- [CLI_OUTPUT_TESTING_GUIDE.md](./CLI_OUTPUT_TESTING_GUIDE.md) - æµ‹è¯•æŒ‡å—
- [.cursor/scratchpad.md](./.cursor/scratchpad.md) - é¡¹ç›®è¿›åº¦è®°å½•

