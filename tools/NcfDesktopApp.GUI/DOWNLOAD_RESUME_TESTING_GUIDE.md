# 📥 断点续传功能测试指南

**版本**: v1.1.0  
**测试日期**: 2025-11-17

---

## 🎯 测试目标

验证 NCF 程序包下载的断点续传功能，确保：
1. ✅ 下载中断后可以继续
2. ✅ 版本验证机制正常工作
3. ✅ 元信息文件正确管理
4. ✅ 日志输出清晰易懂

---

## 📋 测试场景

### 场景 1: 正常断点续传（同一版本）

**测试步骤**：
1. 启动 NCF Desktop App
2. 在"设置"页面点击下载 NCF 程序包
3. 等待下载进度到达 **30%-50%** 之间
4. 强制关闭应用程序（杀进程）
5. 重新启动应用程序
6. 再次点击下载 NCF 程序包

**预期结果**：
```
✅ 检测到同一版本的未完成下载，可以断点续传
📥 从 XX,XXX,XXX 字节处继续下载: senparc-ncf-template.zip
✅ 服务器支持断点续传，继续下载
[进度] XX% → 100%
✅ 下载完成: senparc-ncf-template.zip
🧹 已清理下载信息文件
```

**验证点**：
- [ ] 日志显示"检测到同一版本的未完成下载"
- [ ] 下载从中断位置继续，而非从 0% 开始
- [ ] 下载完成后 `.download` 文件自动删除
- [ ] 最终文件可以正常解压

---

### 场景 2: 版本变更（模拟新版本发布）

**测试步骤**：
1. 下载 NCF 程序包到 **50%**
2. 关闭应用程序
3. 手动编辑 `.download` 文件，修改 URL 中的版本号（模拟新版本）
   ```
   原内容: https://example.com/.../v1.2.3/...
   修改为: https://example.com/.../v1.2.4/...
   ```
4. 重新启动应用程序
5. 点击下载 NCF 程序包

**预期结果**：
```
⚠️ 检测到不同版本的文件，删除旧文件
   旧版本: https://example.com/.../v1.2.3/...
   新版本: https://example.com/.../v1.2.4/...
📥 开始下载: senparc-ncf-template.zip
[进度] 0% → 100%
✅ 下载完成: senparc-ncf-template.zip
🧹 已清理下载信息文件
```

**验证点**：
- [ ] 日志显示"检测到不同版本的文件"
- [ ] 显示新旧版本的 URL 对比
- [ ] 旧文件和 `.download` 文件被删除
- [ ] 下载从 0% 重新开始

---

### 场景 3: 元信息文件丢失

**测试步骤**：
1. 下载 NCF 程序包到 **40%**
2. 关闭应用程序
3. 手动删除 `.download` 文件（保留部分下载的主文件）
4. 重新启动应用程序
5. 点击下载 NCF 程序包

**预期结果**：
```
⚠️ 未找到下载信息文件，无法确认版本，重新下载
📥 开始下载: senparc-ncf-template.zip
[进度] 0% → 100%
✅ 下载完成: senparc-ncf-template.zip
🧹 已清理下载信息文件
```

**验证点**：
- [ ] 日志显示"未找到下载信息文件"
- [ ] 旧的部分文件被删除
- [ ] 下载从 0% 重新开始
- [ ] 新的 `.download` 文件被创建

---

### 场景 4: 完整下载（无中断）

**测试步骤**：
1. 启动 NCF Desktop App
2. 点击下载 NCF 程序包
3. 等待下载完成（不中断）

**预期结果**：
```
📥 开始下载: senparc-ncf-template.zip
[进度] 0% → 100%
✅ 下载完成: senparc-ncf-template.zip
🧹 已清理下载信息文件
```

**验证点**：
- [ ] 下载进度平滑增长
- [ ] 下载完成后 `.download` 文件被删除
- [ ] 只留下最终的 zip 文件
- [ ] 文件可以正常解压

---

### 场景 5: 服务器不支持断点续传（降级处理）

**测试步骤**：
1. 下载 NCF 程序包到 **30%**
2. 关闭应用程序
3. （假设服务器返回 200 而非 206）
4. 重新启动并下载

**预期结果**：
```
⚠️ 服务器不支持断点续传，重新下载
📥 开始下载: senparc-ncf-template.zip
[进度] 0% → 100%
✅ 下载完成: senparc-ncf-template.zip
```

**验证点**：
- [ ] 日志显示"服务器不支持断点续传"
- [ ] 程序自动降级为完整下载
- [ ] 下载成功完成

---

## 🔍 文件系统检查

### 下载过程中应存在的文件：
```
Downloads/
├── senparc-ncf-template.zip         # 部分下载的文件
└── senparc-ncf-template.zip.download # 元信息文件（存储 URL）
```

### 下载完成后应存在的文件：
```
Downloads/
└── senparc-ncf-template.zip         # 完整的压缩包
```

### `.download` 文件内容示例：
```
https://gitee.com/NeuCharFramework/NcfPackageSources/releases/download/v1.2.3/senparc-ncf-template.zip
```

---

## 📊 测试检查清单

### 功能验证
- [ ] 同一版本断点续传正常工作
- [ ] 不同版本自动删除旧文件
- [ ] 元信息文件缺失时安全处理
- [ ] 下载完成后清理临时文件
- [ ] 服务器不支持 Range 时降级处理

### 日志输出验证
- [ ] 开始下载时有明确提示
- [ ] 版本不一致时显示新旧版本对比
- [ ] 下载进度实时更新
- [ ] 下载完成有明确提示
- [ ] 清理临时文件有日志记录

### 异常处理验证
- [ ] 网络中断后恢复正常
- [ ] 文件权限问题有错误提示
- [ ] 磁盘空间不足有错误提示

### 文件完整性验证
- [ ] 下载的 zip 文件可以正常解压
- [ ] 解压后的文件内容完整
- [ ] 没有版本混淆导致的文件损坏

---

## 🐛 已知问题和限制

### 限制
1. **URL 作为版本标识**
   - 依赖 URL 包含版本信息
   - URL 不变但内容变化时无法检测（极端情况）

2. **服务器支持**
   - 服务器必须支持 HTTP Range 请求才能断点续传
   - 不支持时自动降级为完整下载

3. **元信息文件**
   - 用户手动删除 `.download` 文件会导致重新下载
   - 这是安全优先的设计，避免版本混淆

---

## 🎯 成功标准

所有测试场景通过，且满足以下条件：
- ✅ 断点续传功能正常工作
- ✅ 版本验证机制有效防止文件损坏
- ✅ 日志输出清晰易懂
- ✅ 异常情况优雅处理
- ✅ 下载的文件完整无损

---

## 📝 测试记录模板

```markdown
## 测试记录

**测试人员**: _________  
**测试时间**: _________  
**应用版本**: v1.1.0

| 场景 | 测试结果 | 备注 |
|------|---------|------|
| 场景 1: 正常断点续传 | ✅ / ❌ |  |
| 场景 2: 版本变更 | ✅ / ❌ |  |
| 场景 3: 元信息丢失 | ✅ / ❌ |  |
| 场景 4: 完整下载 | ✅ / ❌ |  |
| 场景 5: 服务器降级 | ✅ / ❌ |  |

**整体评价**: _________  
**发现的问题**: _________  
**改进建议**: _________
```

---

**文档更新**: 2025-11-17  
**相关文档**: [DOWNLOAD_RESUME_VERSION_CHECK.md](./DOWNLOAD_RESUME_VERSION_CHECK.md)

