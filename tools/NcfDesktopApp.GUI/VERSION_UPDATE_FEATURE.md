# 版本更新检测和数据保护功能说明

## 📋 功能概述

NCF Desktop App 现在支持智能版本更新检测和完整的数据保护机制，确保用户在更新过程中不会丢失任何数据。

---

## 🆕 新增功能

### 1. 版本更新检测

应用启动时会自动检测：
- 💾 **当前已安装版本**
- 🌐 **最新可用版本**
- 🔄 **版本对比**

### 2. 用户确认对话框

当检测到新版本时，会显示友好的确认对话框：

```
检测到 NeuCharFramework 有新版本可用：

当前版本: v1.0.0
最新版本: v1.1.0

是否更新到最新版本？

注意：
• 更新将保留您的数据库和配置文件
• 选择"继续使用当前版本"将跳过更新

[更新]  [继续使用当前版本]
```

### 3. 数据保护机制

#### 自动备份和恢复
- 🛡️ **App_Data 文件夹完整备份**（包含所有 SQLite 数据库）
- ⚙️ **配置文件备份**（appsettings*.json）
- 🔄 **自动恢复**：更新后立即恢复所有数据

#### 保护范围
- ✅ SQLite 数据库文件（*.db, *.sqlite, *.sqlite3）
- ✅ 所有 App_Data 子目录和文件
- ✅ 应用配置文件（带智能冲突检测）
- ✅ 用户上传的文件
- ✅ 🆕 logs 文件夹（所有日志文件，同时支持 log 文件夹）

---

## 🔄 工作流程

### 首次安装
```
启动应用
  ↓
检测版本 → 未安装
  ↓
直接下载最新版本
  ↓
启动 NCF
```

### 已安装相同版本
```
启动应用
  ↓
检测版本 → 版本相同
  ↓
跳过下载，直接启动
  ↓
启动 NCF
```

### 检测到新版本
```
启动应用
  ↓
检测版本 → 发现新版本
  ↓
显示确认对话框
  ├─ [更新]
  │   ↓
  │  备份数据
  │   ↓
  │  下载新版本
  │   ↓
  │  清理旧文件
  │   ↓
  │  解压新版本
  │   ↓
  │  恢复数据
  │   ↓
  │  启动 NCF
  │
  └─ [继续使用当前版本]
      ↓
     跳过下载
      ↓
     直接启动 NCF
```

---

## 💾 数据保护详细说明

### 备份阶段（PreserveImportantFiles）
1. **创建临时备份目录**
   - 位置: `AppData/backup/`
   
2. **完整复制 App_Data 文件夹**
   ```
   App_Data/
   ├── Database.db        ← SQLite 数据库
   ├── Uploads/           ← 用户上传文件
   ├── Cache/             ← 缓存文件
   └── ...                ← 其他数据文件
   ```

3. **🆕 完整复制 logs 文件夹**
   ```
   logs/
   ├── app.log           ← 应用日志
   ├── error.log         ← 错误日志
   └── ...               ← 其他日志文件
   ```
   
   注：同时支持 `log/` 文件夹（向后兼容）

4. **备份配置文件**
   - `appsettings.json`
   - `appsettings.Production.json`
   - `appsettings.Development.json`
   - 等等...

### 清理阶段（SafeCleanRuntimeDirectory）
- ✅ 删除旧程序文件
- ❌ **跳过** App_Data 目录
- ❌ **跳过** logs 目录（及 log 目录）🆕
- ❌ **跳过** 配置文件
- ✅ 保持目录结构

### 恢复阶段（RestoreImportantFiles）
1. **恢复 App_Data 文件夹**
   - 递归复制所有文件和子目录
   - 覆盖同名文件
   
2. **🆕 恢复 logs 文件夹**
   - 保留所有日志文件
   - 便于问题追踪
   - 同时支持 log 文件夹（向后兼容）
   
3. **🆕 智能恢复配置文件（带冲突检测）**
   - 比较旧配置和新配置内容
   - 如果内容相同，直接使用新配置
   - 如果内容不同，弹出确认对话框让用户选择：
     - **使用旧配置**：保留自定义设置，新配置备份为 `appsettings.backup-yyyyMMdd-HHmmss.json`
     - **使用新配置**：采用新版本默认设置，旧配置另存为 `appsettings.old-yyyyMMdd-HHmmss.json`
   
4. **清理临时备份**
   - 删除临时备份目录

---

## 🔒 安全保障

### 文件保护规则

#### 保留的文件（ShouldPreserveFile）
```csharp
// 1. App_Data 中的所有文件
if (relativePath.StartsWith("App_Data"))
    return true;

// 2. 🆕 logs/log 中的所有文件
if (relativePath.StartsWith("logs") || relativePath.StartsWith("log"))
    return true;

// 3. 所有 appsettings*.json 文件
if (fileName.StartsWith("appsettings") && fileName.EndsWith(".json"))
    return true;
```

#### 保留的目录（ShouldPreserveDirectory）
```csharp
// 1. App_Data 及其所有子目录
if (relativePath.StartsWith("App_Data"))
    return true;

// 2. 🆕 logs/log 及其所有子目录
if (relativePath.StartsWith("logs") || relativePath.StartsWith("log"))
    return true;
```

### 错误处理
- ✅ 备份失败：记录警告，继续更新
- ✅ 恢复失败：记录警告，但不影响启动
- ✅ 清理失败：记录错误，手动清理

---

## 📊 用户体验

### 日志输出示例

#### 首次安装
```
[10:30:00] 🚀 开始启动 NCF...
[10:30:01] ℹ️ 首次安装，将下载最新版本
[10:30:02] 正在下载 NCF-v1.0.0...
[10:30:10] ✅ 下载完成
[10:30:11] 正在提取文件...
[10:30:15] ✅ 文件提取完成
[10:30:16] 🌐 启动 NCF 进程...
```

#### 检测到新版本（用户选择更新，无配置冲突）
```
[10:30:00] 🔍 检查最新版本...
[10:30:01] 📋 最新版本: v1.1.0
[10:30:01] 💾 当前已安装版本: v1.0.0
[10:30:01] 🆕 发现新版本可用！
[10:30:01]    当前版本: v1.0.0
[10:30:01]    最新版本: v1.1.0
[10:30:05] ✅ 用户选择更新到最新版本
[10:30:06] 🛡️ 开始保护重要文件...
[10:30:06] ✅ App_Data 文件夹已备份
[10:30:06] ✅ logs 文件夹已备份
[10:30:06] ✅ 已备份配置文件: appsettings.json
[10:30:06] ✅ 重要文件保护完成
[10:30:07] 🧹 开始安全清理 Runtime 目录...
[10:30:08] 正在下载 NCF-v1.1.0...
[10:30:15] ✅ 下载完成
[10:30:16] 正在提取文件...
[10:30:20] 🔄 开始恢复重要文件...
[10:30:20] ✅ App_Data 文件夹已恢复
[10:30:20] ✅ logs 文件夹已恢复
[10:30:20] ℹ️ 配置文件内容相同，无需处理: appsettings.json
[10:30:20] ✅ 重要文件恢复完成
[10:30:21] 🌐 启动 NCF 进程...
```

#### 🆕 检测到新版本（用户选择更新，有配置冲突）
```
[10:30:00] 🔍 检查最新版本...
[10:30:01] 📋 最新版本: v1.1.0
[10:30:01] 💾 当前已安装版本: v1.0.0
[10:30:01] 🆕 发现新版本可用！
[10:30:05] ✅ 用户选择更新到最新版本
[10:30:06] 🛡️ 开始保护重要文件...
[10:30:15] ✅ 下载完成
[10:30:16] 正在提取文件...
[10:30:20] 🔄 开始恢复重要文件...
[10:30:20] ✅ App_Data 文件夹已恢复
[10:30:20] ✅ logs 文件夹已恢复
[10:30:21] ⚠️ 检测到配置文件冲突: appsettings.json
[10:30:21]    旧文件大小: 1523 字符
[10:30:21]    新文件大小: 1687 字符
[10:30:21] ⚠️ 配置文件冲突: appsettings.json
[10:30:21]    需要用户决策...
[10:30:25] ✅ 用户选择：使用旧配置覆盖
[10:30:25] 📦 已存档新版本配置文件: appsettings.backup-20251116-103025.json
[10:30:25] ✅ 已恢复旧配置文件: appsettings.json
[10:30:26] ✅ 重要文件恢复完成
[10:30:27] 🌐 启动 NCF 进程...
```

#### 检测到新版本（用户选择继续使用当前版本）
```
[10:30:00] 🔍 检查最新版本...
[10:30:01] 📋 最新版本: v1.1.0
[10:30:01] 💾 当前已安装版本: v1.0.0
[10:30:01] 🆕 发现新版本可用！
[10:30:01]    当前版本: v1.0.0
[10:30:01]    最新版本: v1.1.0
[10:30:05] ℹ️ 用户选择继续使用当前版本
[10:30:05] ⏭️ 跳过下载和提取，使用现有版本
[10:30:06] 🌐 启动 NCF 进程...
```

#### 版本相同
```
[10:30:00] 🔍 检查最新版本...
[10:30:01] 📋 最新版本: v1.0.0
[10:30:01] 💾 当前已安装版本: v1.0.0
[10:30:01] ✅ 当前已是最新版本
[10:30:02] ⏭️ 跳过下载和提取，使用现有版本
[10:30:03] 🌐 启动 NCF 进程...
```

---

## 🛠️ 技术实现

### 核心方法

#### NcfService.cs
- `GetInstalledVersionAsync()` - 获取当前安装的版本
- `PreserveImportantFilesAsync()` - 备份重要文件（App_Data + logs + 配置）
- `SafeCleanRuntimeDirectoryAsync()` - 安全清理目录
- `RestoreImportantFilesAsync()` - 恢复重要文件
- `RestoreAppSettingsFilesAsync()` - 🆕 智能恢复配置文件（带冲突检测）
- `HandleAppSettingsConflictAsync()` - 🆕 处理配置文件冲突
- `ShouldPreserveFile()` - 判断是否保留文件（含 logs 文件夹）
- `ShouldPreserveDirectory()` - 判断是否保留目录（含 logs 文件夹）
- `OnAppSettingsConflict` - 🆕 配置文件冲突处理回调

#### MainWindowViewModel.cs
- `CheckLatestVersionAsync()` - 检查最新版本
- `CheckAndConfirmUpdateAsync()` - 检查并确认更新
- `ShowConfirmDialogAsync()` - 显示确认对话框
- `HandleAppSettingsConflictAsync()` - 🆕 处理配置文件冲突对话框

### 数据存储位置

#### Windows
```
C:\Users\{Username}\AppData\Roaming\NcfDesktopApp\
├── Runtime\              ← NCF 运行文件
│   └── App_Data\        ← 数据库和配置（被保护）
├── Downloads\           ← 临时下载文件
└── backup\              ← 临时备份（更新时）
```

#### macOS/Linux
```
~/.config/NcfDesktopApp/
├── Runtime/
│   └── App_Data/
├── Downloads/
└── backup/
```

---

## ✅ 测试验证

### 测试场景

1. **首次安装测试** ✅
   - 无现有版本
   - 自动下载最新版本

2. **版本相同测试** ✅
   - 当前版本 = 最新版本
   - 跳过下载，直接启动

3. **版本更新测试（选择更新）** ✅
   - 当前版本 < 最新版本
   - 用户选择更新
   - 备份、清理、解压、恢复
   - 数据完整性验证

4. **版本更新测试（选择跳过）** ✅
   - 当前版本 < 最新版本
   - 用户选择继续使用当前版本
   - 直接启动，不下载

5. **数据保护测试** ✅
   - 创建测试数据库文件
   - 执行更新
   - 验证数据完整性

6. **错误处理测试** ✅
   - 备份失败场景
   - 网络断开场景
   - 磁盘空间不足场景

---

## 🔧 配置选项

### 自动清理下载文件
在设置中可以配置：
- ✅ **自动清理**（默认）：更新后自动删除下载的 ZIP 文件
- ❌ **不清理**：保留下载文件供离线使用

---

## 📝 最佳实践

### 用户建议
1. **定期更新**：及时更新到最新版本以获得最新功能和安全修复
2. **手动备份**：虽然应用会自动备份，但建议定期手动备份 App_Data 文件夹
3. **测试更新**：在生产环境更新前，建议先在测试环境验证

### 开发者建议
1. **版本号规范**：使用语义化版本号（Semantic Versioning）
2. **向后兼容**：确保数据库架构向后兼容
3. **迁移脚本**：如需修改数据库结构，提供迁移脚本

---

## 🐛 故障排查

### 常见问题

#### Q: 更新后数据丢失？
**A**: 检查日志，确认备份和恢复步骤是否成功执行。
      临时备份位置：`AppData/backup/`

#### Q: 更新失败如何恢复？
**A**: 
1. 检查临时备份是否存在
2. 手动复制 `backup/App_Data` 到 `Runtime/App_Data`
3. 重新启动应用

#### Q: 如何强制重新下载？
**A**: 
1. 停止 NCF
2. 删除 `Runtime` 文件夹
3. 删除 `Downloads` 文件夹中的 ZIP 文件
4. 重新启动应用

---

## 📚 相关文档

- [FILE_PROTECTION_MECHANISM.md](./FILE_PROTECTION_MECHANISM.md) - 文件保护机制详细说明
- [README.md](./README.md) - 项目总体说明
- [build-tool/TESTING_GUIDE.md](./build-tool/TESTING_GUIDE.md) - 测试指南

---

## 🎯 未来改进

### 计划功能
- [ ] 增量更新：只下载变更的文件
- [ ] 自动备份历史：保留多个版本的备份
- [ ] 回滚功能：一键回滚到上一个版本
- [ ] 更新日志显示：显示版本更新内容
- [ ] 静默更新选项：后台自动更新（可选）

---

---

## 🆕 版本 1.1.0 更新内容

### 新增功能
1. **🆕 logs 文件夹保护**
   - 自动备份和恢复 `logs/` 文件夹
   - 同时支持 `log/` 文件夹（向后兼容）
   - 保留所有日志文件，便于问题追踪

2. **🆕 配置文件智能冲突检测**
   - 自动比较旧配置和新配置内容
   - 内容相同时自动使用新配置
   - 内容不同时弹出用户选择对话框
   - 无论选择哪个，另一个都会被备份

3. **🆕 配置文件备份命名优化**
   - 使用旧配置时：`appsettings.backup-yyyyMMdd-HHmmss.json`
   - 保留新配置时：`appsettings.old-yyyyMMdd-HHmmss.json`
   - 便于识别和追溯

### 对话框示例

#### 配置文件冲突对话框
```
检测到配置文件冲突：

文件名: appsettings.json

旧配置大小: 1523 字符
新配置大小: 1687 字符

选择"使用旧配置"将保留您的自定义设置
选择"使用新配置"将使用新版本的默认设置

注意：
• 使用旧配置：新版本配置将备份为 appsettings.json.backup-[日期].json
• 使用新配置：旧配置将另存为 appsettings.json.old-[日期].json

[使用旧配置]  [使用新配置]
```

---

**最后更新**: 2025-11-16
**版本**: 1.1.0

