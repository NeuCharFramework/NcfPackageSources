# NCF 桌面应用 - 内嵌浏览器集成项目

## 📌 项目概览

### 背景和动机
用户希望在 NCF 桌面应用中实现真正的内嵌浏览器功能，让用户无需打开外部浏览器即可直接在桌面应用的标签页中访问 NCF 启动后的网页（如 http://localhost:5000）。

**当前痛点**：
- ❌ 现有 EmbeddedWebView 只是占位符实现，无法真正渲染网页
- ❌ 用户必须通过外部浏览器访问 NCF，体验割裂
- ❌ WebView.Avalonia 包已添加但未被正确使用

### 核心目标
1. **Windows 平台优先**：实现完整的 WebView2 集成，提供原生浏览器体验
2. **跨平台支持**：确保 macOS 和 Linux 也能内嵌显示网页
3. **无缝体验**：用户启动 NCF 后自动在内嵌浏览器中显示
4. **完整功能**：支持前进、后退、刷新等基本浏览器操作

### 技术栈
- **Windows**: Microsoft.Web.WebView2 (免费)
- **macOS**: WebView.Avalonia (基于 WKWebView)
- **Linux**: WebView.Avalonia (基于 WebKitGTK)
- **框架**: Avalonia 11.3.2
- **语言**: C# / .NET 8.0

---

## 🎯 规划者分析

### 需求分析

#### 功能需求
| 需求ID | 功能描述 | 优先级 | 平台 |
|--------|----------|--------|------|
| F001 | 内嵌 WebView2 控件（Windows） | 🔥 高 | Windows |
| F002 | 自动导航到 NCF 站点 URL | 🔥 高 | 全平台 |
| F003 | 支持前进/后退/刷新操作 | 🔥 高 | 全平台 |
| F004 | 集成 WebView.Avalonia（macOS/Linux） | 🔥 高 | macOS/Linux |
| F005 | 错误处理和降级方案 | 🔥 高 | 全平台 |
| F006 | 加载状态显示 | 中 | 全平台 |
| F007 | 开发者工具集成（可选） | 低 | Windows |

#### 非功能需求
- **性能**: 页面加载时间 < 3秒
- **兼容性**: 支持 Windows 10/11, macOS 11+, Ubuntu 20.04+
- **可维护性**: 模块化设计，易于扩展
- **用户体验**: 与原生浏览器体验一致

### 技术架构

#### 架构设计
```
┌─────────────────────────────────────────────────────┐
│          BrowserView (AXAML)                        │
│  ┌───────────────────────────────────────────────┐  │
│  │  Toolbar (前进/后退/刷新/URL显示)              │  │
│  └───────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────┐  │
│  │         PlatformWebView (抽象层)              │  │
│  │  ┌─────────────────┬──────────────────────┐  │  │
│  │  │  Windows:       │  macOS/Linux:        │  │  │
│  │  │  WebView2       │  WebView.Avalonia    │  │  │
│  │  │  Control        │  Control             │  │  │
│  │  └─────────────────┴──────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

#### 技术选型理由

**Windows - WebView2**:
- ✅ 免费开源
- ✅ Windows 10/11 内置 Runtime
- ✅ 基于 Chromium，完整的现代 Web 支持
- ✅ 性能优异
- ✅ Microsoft 官方支持

**macOS/Linux - WebView.Avalonia**:
- ✅ 免费开源
- ✅ 使用系统原生浏览器引擎
- ✅ 已在项目中添加
- ✅ 与 Avalonia 深度集成

### 风险评估

#### 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| WebView2 Runtime 未安装（Windows） | 高 | 低 | 自动下载安装 Runtime |
| WebView.Avalonia 兼容性问题 | 中 | 中 | 提供外部浏览器降级方案 |
| 不同平台 API 差异 | 中 | 高 | 设计抽象层统一接口 |
| 内存占用过高 | 低 | 低 | 实现资源清理机制 |

#### 解决方案
1. **运行时检测**: 启动时检测 WebView2 Runtime
2. **自动安装**: 提供一键安装 Runtime 功能
3. **降级方案**: 无法使用内嵌浏览器时自动打开外部浏览器
4. **错误提示**: 清晰的错误信息和解决建议

---

## 📋 任务看板

### 阶段 1️⃣: Windows WebView2 集成（优先）
> 详细步骤：参见 [step-01-windows-webview2.md](.cursor/steps/step-01-windows-webview2.md)

#### ⏳ 待开始
- [ ] **[T1.1]** 添加 Microsoft.Web.WebView2 NuGet 包 (预计: 0.5小时)
- [ ] **[T1.2]** 创建 WindowsWebView2Control.cs 控件 (预计: 2小时)
- [ ] **[T1.3]** 实现 WebView2 初始化和事件处理 (预计: 2小时)
- [ ] **[T1.4]** 集成到 BrowserView.axaml (预计: 1小时)
- [ ] **[T1.5]** 测试 Windows 平台功能 (预计: 1小时)

**总预计时间**: ~6.5小时

### 阶段 2️⃣: WebView.Avalonia 配置（macOS/Linux）
> 详细步骤：参见 [step-02-avalonia-webview.md](.cursor/steps/step-02-avalonia-webview.md)

#### ⏳ 待开始
- [ ] **[T2.1]** 验证 WebView.Avalonia 包配置 (预计: 0.5小时)
- [ ] **[T2.2]** 创建 AvaloniaWebViewControl.cs (预计: 2小时)
- [ ] **[T2.3]** 实现平台特定初始化逻辑 (预计: 2小时)
- [ ] **[T2.4]** 测试 macOS 和 Linux 功能 (预计: 2小时)

**总预计时间**: ~6.5小时

### 阶段 3️⃣: 统一抽象层设计
> 详细步骤：参见 [step-03-abstraction-layer.md](.cursor/steps/step-03-abstraction-layer.md)

#### ⏳ 待开始
- [ ] **[T3.1]** 定义 IPlatformWebView 接口 (预计: 1小时)
- [ ] **[T3.2]** 创建 PlatformWebViewFactory (预计: 1.5小时)
- [ ] **[T3.3]** 重构 EmbeddedWebView 使用抽象层 (预计: 2小时)
- [ ] **[T3.4]** 实现平台检测和自动选择 (预计: 1小时)

**总预计时间**: ~5.5小时

### 阶段 4️⃣: 功能完善和优化
> 详细步骤：参见 [step-04-features-optimization.md](.cursor/steps/step-04-features-optimization.md)

#### ⏳ 待开始
- [ ] **[T4.1]** 实现加载进度显示 (预计: 1小时)
- [ ] **[T4.2]** 添加错误处理和重试机制 (预计: 1.5小时)
- [ ] **[T4.3]** 优化内存和资源管理 (预计: 2小时)
- [ ] **[T4.4]** 添加开发者工具支持（可选） (预计: 1小时)

**总预计时间**: ~5.5小时

### 阶段 5️⃣: 测试和文档
> 详细步骤：参见 [step-05-testing-documentation.md](.cursor/steps/step-05-testing-documentation.md)

#### ⏳ 待开始
- [ ] **[T5.1]** 编写单元测试 (预计: 2小时)
- [ ] **[T5.2]** 跨平台集成测试 (预计: 2小时)
- [ ] **[T5.3]** 性能测试和优化 (预计: 1.5小时)
- [ ] **[T5.4]** 更新用户文档 (预计: 1小时)
- [ ] **[T5.5]** 创建故障排除指南 (预计: 0.5小时)

**总预计时间**: ~7小时

---

## 📊 项目进度

| 阶段 | 状态 | 进度 | 预计完成时间 |
|------|------|------|--------------|
| 1️⃣ Windows WebView2 | ⏳ 待开始 | 0% | 6.5小时 |
| 2️⃣ Avalonia WebView | ⏳ 待开始 | 0% | 6.5小时 |
| 3️⃣ 抽象层设计 | ⏳ 待开始 | 0% | 5.5小时 |
| 4️⃣ 功能完善 | ⏳ 待开始 | 0% | 5.5小时 |
| 5️⃣ 测试文档 | ⏳ 待开始 | 0% | 7小时 |

**总预计时间**: ~31小时（约4个工作日）

---

## 💬 执行者反馈

### 当前进度
等待开始执行...

### 遇到的问题
暂无

### 需要的帮助
暂无

---

## 📚 经验教训

### 技术难点
待执行过程中记录...

### 解决方案
待执行过程中记录...

### 避坑指南
待执行过程中记录...

---

## 🎉 里程碑记录

### 项目启动
- **日期**: 2025-01-XX
- **状态**: ✅ 规划完成，等待执行
- **负责人**: 规划者

---

## 📝 备注

### 替代方案
如果预算允许，可以考虑：
- **Avalonia.Controls.WebView**（商业方案，€89/年起）
  - 优势：配置最简单，跨平台体验最一致
  - 劣势：需要购买许可证

### 参考资源
- [Microsoft WebView2 文档](https://learn.microsoft.com/en-us/microsoft-edge/webview2/)
- [WebView.Avalonia GitHub](https://github.com/OutSystems/WebView)
- [Avalonia 官方文档](https://docs.avaloniaui.net/)

---

**最后更新**: 2025-01-XX  
**版本**: v1.0  
**状态**: 📋 规划阶段

