# NCF Desktop App - CLI 输出实时同步功能

## 📌 项目概览

### 背景和动机
用户希望将运行中的 Senparc.Web CLI 进程的命令行输出（包括 stdout 和 stderr）实时同步显示在 GUI 应用的日志界面中，方便开发者监控和调试 NCF 应用的运行状态。

### 核心目标
1. 实时捕获 Senparc.Web 进程的控制台输出（stdout/stderr）
2. 将 CLI 输出同步到 UI 日志系统中
3. 提供清晰的视觉区分（CLI 输出 vs 应用日志）
4. 保持日志性能和响应速度
5. 支持日志过滤和级别识别

### 技术栈
- **框架**: Avalonia UI + .NET 8
- **进程管理**: System.Diagnostics.Process
- **异步编程**: async/await + Task
- **UI 线程同步**: Dispatcher.UIThread
- **日志系统**: StringBuilder buffer + ObservableProperty

---

## 🎯 规划者分析

### 需求分析

#### 功能需求
1. **实时捕获**: 捕获 Senparc.Web 进程的所有控制台输出
2. **双流处理**: 同时处理 StandardOutput 和 StandardError
3. **UI 同步**: 将输出实时显示到 UI 日志面板
4. **视觉区分**: CLI 输出需要有明显的视觉标识
5. **性能优化**: 大量输出时不阻塞 UI 线程

#### 非功能需求
1. **实时性**: 输出延迟 < 500ms
2. **稳定性**: 不因进程输出导致应用崩溃
3. **可维护性**: 代码结构清晰，易于扩展
4. **用户体验**: 提供日志过滤和搜索功能（可选）

### 技术架构

#### 方案选择

**方案一：混合显示（推荐）✅**
- CLI 输出直接混入现有日志面板
- 使用不同的前缀/颜色标识（如 `[CLI] `）
- 优点：简单直观，用户可以看到完整的操作时间线
- 缺点：日志量大时可能混杂

**方案二：独立窗口**
- 创建新窗口专门显示 CLI 输出
- 优点：信息隔离清晰
- 缺点：需要管理多个窗口，用户体验不佳

**方案三：分 Tab 显示**
- 在日志面板添加 Tab 切换（应用日志 / CLI 输出）
- 优点：信息隔离且 UI 紧凑
- 缺点：需要修改 UI 结构

**最终决策**: 采用**方案一（混合显示）+ 方案三（可选扩展）**
- 第一阶段：实现混合显示，快速满足需求
- 第二阶段：可选添加过滤功能或 Tab 切换

#### 技术实现要点

1. **进程输出捕获**
   - 已设置 `RedirectStandardOutput = true` 和 `RedirectStandardError = true`
   - 使用 `OutputDataReceived` 和 `ErrorDataReceived` 事件
   - 调用 `BeginOutputReadLine()` 和 `BeginErrorReadLine()`

2. **线程安全**
   - 事件回调在后台线程执行
   - 使用 `Dispatcher.UIThread.Post` 更新 UI
   - 避免使用 `Invoke`（同步调用）以防阻塞

3. **日志标识**
   - CLI stdout: `[CLI] 消息内容`
   - CLI stderr: `[CLI:ERROR] 消息内容`
   - 应用日志: `[APP] 消息内容`（可选，区分更清晰）

4. **性能优化**
   - 批量更新日志（如每 100ms 刷新一次）
   - 限制日志行数（已有 1000 行限制）
   - 使用 StringBuilder 缓冲

### 风险评估

| 风险 | 等级 | 影响 | 应对措施 |
|------|------|------|---------|
| CLI 输出量过大导致 UI 卡顿 | 🟡 中 | 用户体验下降 | 实现批量更新机制，限制刷新频率 |
| 进程异常退出导致事件处理异常 | 🟡 中 | 应用崩溃 | 添加 try-catch，优雅处理进程退出 |
| 多线程竞态条件 | 🟢 低 | 日志顺序错乱 | 使用 Dispatcher 确保串行更新 |
| 日志编码问题（中文乱码） | 🟢 低 | 日志不可读 | 设置正确的控制台编码（UTF-8） |

---

## 📋 任务看板

### 🔄 进行中
_暂无任务进行中_

### ⏳ 待开始

#### 阶段一：核心功能实现（预计 2-3 小时）

- [ ] **[TASK-01]** 在 NcfService 中实现 CLI 输出捕获机制 (1.5h)
  - 详细规划：参考 [.cursor/steps/step-01-cli-capture.md]
  - 添加 OutputDataReceived/ErrorDataReceived 事件处理
  - 实现回调函数传递给 ViewModel
  - 处理进程退出和异常情况

- [ ] **[TASK-02]** 在 MainWindowViewModel 中集成 CLI 日志输出 (1h)
  - 详细规划：参考 [.cursor/steps/step-02-viewmodel-integration.md]
  - 添加 AddCliLog 方法
  - 实现线程安全的 UI 更新
  - 区分 CLI 日志和应用日志的显示格式

- [ ] **[TASK-03]** 测试和优化性能 (0.5h)
  - 详细规划：参考 [.cursor/steps/step-03-testing-optimization.md]
  - 测试大量输出时的 UI 响应
  - 验证进程异常退出时的稳定性
  - 检查中文编码是否正常

#### 阶段二：用户体验优化（可选，预计 1-2 小时）

- [ ] **[TASK-04]** 添加日志过滤功能 (1h)
  - 添加过滤下拉框（全部/应用日志/CLI 输出）
  - 实现日志类型筛选逻辑

- [ ] **[TASK-05]** 优化日志视觉呈现 (0.5h)
  - 为 CLI 输出添加不同颜色/图标
  - 优化日志行高和可读性

### ✅ 已完成
_暂无已完成任务_

---

## 💬 执行者反馈

### 当前进度
等待开始执行第一个任务

### 遇到的问题
_暂无_

### 需要的帮助
_暂无_

---

## 📚 经验教训

### 技术难点
_待补充_

### 解决方案
_待补充_

### 避坑指南
_待补充_

---

## 🎉 里程碑记录

_暂无里程碑_

---

**创建日期**: 2025-11-16  
**最后更新**: 2025-11-16  
**当前版本**: v0.1.0 (规划阶段)

