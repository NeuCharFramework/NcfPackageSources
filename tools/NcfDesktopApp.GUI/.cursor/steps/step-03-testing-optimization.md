# Step 03: 测试和优化性能

## 📋 任务概述
全面测试 CLI 输出同步功能，发现并解决性能问题，确保功能稳定可靠。

## 🎯 目标
- ✅ 验证基本功能正确性
- ✅ 测试极端场景（大量输出、异常退出等）
- ✅ 识别和优化性能瓶颈
- ✅ 确保中文显示正确
- ✅ 验证跨平台兼容性

## 📂 涉及文件
- 所有相关文件（Services/NcfService.cs, ViewModels/MainWindowViewModel.cs）

## 🧪 测试清单

### 1. 基本功能测试

#### 测试 1.1：正常启动和日志捕获
**步骤**：
1. 启动 NcfDesktopApp
2. 点击"启动"按钮
3. 观察日志面板

**预期结果**：
- ✅ 出现 `[APP]` 开头的应用日志
- ✅ 出现 `[CLI]` 开头的 NCF 启动日志
- ✅ 日志实时更新，无明显延迟（< 1s）
- ✅ 日志顺序正确（按时间排序）

#### 测试 1.2：错误输出捕获
**步骤**：
1. 修改 NCF 端口为已占用的端口（如 80）
2. 启动 NCF
3. 观察日志

**预期结果**：
- ✅ 出现 `[CLI:ERROR]` 开头的错误信息
- ✅ 错误信息完整显示
- ✅ 应用不崩溃

#### 测试 1.3：进程退出处理
**步骤**：
1. 启动 NCF
2. 点击"停止"按钮
3. 观察日志

**预期结果**：
- ✅ 出现进程退出消息
- ✅ 应用状态正确更新
- ✅ 无异常或错误

---

### 2. 性能测试

#### 测试 2.1：大量日志输出
**步骤**：
1. 启动 NCF（ASP.NET Core 启动时会输出大量日志）
2. 观察 UI 响应速度
3. 检查 CPU 和内存占用

**预期结果**：
- ✅ UI 不卡顿，按钮可点击
- ✅ 日志滚动流畅
- ✅ CPU 占用合理（< 20%）
- ✅ 内存稳定（无持续增长）

**性能基准**：
- 100 条/秒日志输出 → UI 响应正常
- 500 条/秒日志输出 → 可能需要批量更新优化

#### 测试 2.2：日志行数限制
**步骤**：
1. 长时间运行 NCF（模拟大量日志）
2. 检查日志行数

**预期结果**：
- ✅ 日志行数不超过 1000 行
- ✅ 旧日志被正确删除
- ✅ 内存占用稳定

#### 测试 2.3：快速启停
**步骤**：
1. 连续快速点击"启动"和"停止"按钮 10 次
2. 观察应用状态

**预期结果**：
- ✅ 应用不崩溃
- ✅ 无内存泄漏
- ✅ 日志显示正常

---

### 3. 中文编码测试

#### 测试 3.1：中文日志显示
**步骤**：
1. 在 NCF 应用中输出中文日志
2. 观察 UI 显示

**预期结果**：
- ✅ 中文显示正确，无乱码
- ✅ Emoji 显示正常（如果有）

**修复方案**（如果出现乱码）：
```csharp
// 在 NcfService.cs 的 startInfo 中添加
startInfo.StandardOutputEncoding = System.Text.Encoding.UTF8;
startInfo.StandardErrorEncoding = System.Text.Encoding.UTF8;
```

---

### 4. 异常场景测试

#### 测试 4.1：进程异常退出
**步骤**：
1. 启动 NCF
2. 使用任务管理器强制终止 NCF 进程
3. 观察应用反应

**预期结果**：
- ✅ 应用检测到进程退出
- ✅ 显示退出消息
- ✅ 应用不崩溃
- ✅ 状态正确更新为"已停止"

#### 测试 4.2：回调异常处理
**步骤**：
1. 模拟回调抛出异常（临时修改代码）
2. 启动 NCF

**预期结果**：
- ✅ 异常被 catch 捕获
- ✅ 日志记录警告信息
- ✅ 应用继续运行

#### 测试 4.3：线程安全
**步骤**：
1. 同时触发大量日志输出（模拟高并发）
2. 观察日志显示

**预期结果**：
- ✅ 无日志丢失
- ✅ 无乱序（时间戳顺序正确）
- ✅ 无崩溃或异常

---

### 5. 跨平台测试

#### 测试 5.1：Windows 平台
**步骤**：
1. 在 Windows 上运行应用
2. 执行所有基本功能测试

**预期结果**：
- ✅ 所有功能正常

#### 测试 5.2：macOS 平台
**步骤**：
1. 在 macOS 上运行应用
2. 执行所有基本功能测试

**预期结果**：
- ✅ 所有功能正常
- ✅ 自包含可执行文件启动正常

#### 测试 5.3：Linux 平台（如果支持）
**步骤**：
1. 在 Linux 上运行应用
2. 执行所有基本功能测试

**预期结果**：
- ✅ 所有功能正常

---

## 🔧 优化建议

### 优化 1：批量更新（如果性能不足）

**触发条件**：日志输出频率 > 200 条/秒时 UI 卡顿

**实现方案**：
参考 `step-02-viewmodel-integration.md` 中的批量更新代码。

**性能提升**：
- UI 更新频率：每条日志 → 每 200ms
- CPU 占用：降低 50-70%
- UI 流畅度：显著提升

### 优化 2：虚拟滚动（如果日志行数过多）

**触发条件**：日志行数 > 5000 行时滚动卡顿

**实现方案**：
- 使用 Avalonia 的 `VirtualizingStackPanel`
- 只渲染可见区域的日志行
- 需要将日志从 string 改为 ObservableCollection<LogEntry>

### 优化 3：日志压缩

**触发条件**：内存占用 > 100MB

**实现方案**：
```csharp
// 压缩重复日志
private string CompressLogs(string logText)
{
    var lines = logText.Split('\n');
    var compressed = new List<string>();
    string lastLine = null;
    int repeatCount = 0;
    
    foreach (var line in lines)
    {
        if (line == lastLine)
        {
            repeatCount++;
        }
        else
        {
            if (repeatCount > 1)
            {
                compressed.Add($"    (上一行重复 {repeatCount} 次)");
            }
            compressed.Add(line);
            lastLine = line;
            repeatCount = 1;
        }
    }
    
    return string.Join('\n', compressed);
}
```

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有基本功能测试通过
- [ ] 所有异常场景测试通过
- [ ] 跨平台兼容性验证通过

### 性能指标
- [ ] 正常日志输出（< 100 条/秒）UI 流畅
- [ ] 大量日志输出（200-500 条/秒）可用
- [ ] 内存占用稳定（< 150MB，含 NCF 进程）
- [ ] 日志行数限制生效

### 用户体验
- [ ] 中文显示正常
- [ ] 日志实时更新，无明显延迟
- [ ] 界面响应迅速，无卡顿
- [ ] 错误提示清晰友好

---

## 📝 测试报告模板

```markdown
## CLI 输出同步功能测试报告

**测试日期**：2025-11-16
**测试平台**：Windows 11 / macOS 15 / Linux
**测试人员**：[姓名]

### 测试结果概览
- 基本功能：✅ 通过 / ⚠️ 部分通过 / ❌ 未通过
- 性能测试：✅ 通过 / ⚠️ 部分通过 / ❌ 未通过
- 异常场景：✅ 通过 / ⚠️ 部分通过 / ❌ 未通过

### 发现的问题
1. [问题描述]
   - 严重程度：🔴 高 / 🟡 中 / 🟢 低
   - 复现步骤：...
   - 预期结果：...
   - 实际结果：...

### 性能数据
- 平均日志输出频率：XX 条/秒
- UI 响应时间：XX ms
- CPU 占用：XX%
- 内存占用：XX MB

### 建议
- [优化建议或改进方向]
```

---

## 🐛 常见问题排查

### 问题 1：日志不显示
**可能原因**：
- 回调未正确注册
- Dispatcher 调用错误
- 进程未正确启动

**排查步骤**：
1. 检查 `OnProcessOutput` 是否赋值
2. 检查 `BeginOutputReadLine()` 是否调用
3. 添加断点验证回调是否触发

### 问题 2：中文乱码
**可能原因**：
- 编码设置错误

**解决方案**：
```csharp
startInfo.StandardOutputEncoding = System.Text.Encoding.UTF8;
startInfo.StandardErrorEncoding = System.Text.Encoding.UTF8;
```

### 问题 3：UI 卡顿
**可能原因**：
- 日志更新过于频繁
- 在 UI 线程进行耗时操作

**解决方案**：
- 实现批量更新机制
- 使用 `Post` 而非 `Invoke`

### 问题 4：内存持续增长
**可能原因**：
- 日志行数限制未生效
- 事件未正确取消订阅

**解决方案**：
- 验证日志截断逻辑
- 停止时清理回调

---

## 🔗 相关任务
- 上一步：[Step 02: 在 MainWindowViewModel 中集成 CLI 日志输出](./step-02-viewmodel-integration.md)
- 下一步：完成核心功能，可选进行 UI 增强（TASK-04, TASK-05）

